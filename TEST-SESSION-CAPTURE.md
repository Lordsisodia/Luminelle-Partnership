# Session Capture System - Testing Guide

**Status**: ✅ Deployed and Tested
**Commit**: ee99e5d (initial), upcoming (fixes)
**Date**: 2026-01-26
**Latest Test**: ✅ All hooks working correctly

---

## Quick Verification

### 1. Check Hooks Exist

```bash
cd /Users/shaansisodia/DEV/client-projects/lumelle
ls -la blackbox5/.claude/hooks/ | grep -E "create-session|update-timeline"
```

Should see:
```
create-session-record.sh
update-timeline.sh
```

### 2. Check Configuration

```bash
cat blackbox5/.claude/settings.json | jq '.hooks.SessionEnd[0].hooks[] | .command'
cat blackbox5/.claude/settings.json | jq '.env.BLACKBOX5_MEMORY_PATH'
```

Should show:
- `create-session-record.sh` and `update-timeline.sh` in SessionEnd
- Memory path is `./blackbox5/5-project-memory/lumelle`

### 3. Manual Test

```bash
export BLACKBOX5_MEMORY_PATH=./blackbox5/5-project-memory/lumelle
echo '{"session_id": "test-manual-123", "transcript_path": "/dev/null"}' | \
  blackbox5/.claude/hooks/create-session-record.sh

# Verify session folder was created
LATEST=$(ls -t blackbox5/5-project-memory/lumelle/operations/sessions/ | head -1)
ls -la "blackbox5/5-project-memory/lumelle/operations/sessions/$LATEST"
```

Should see:
```
context.json
metrics.json
README.md
transcript.jsonl
```

---

## Real Test with Claude Code

### Step 1: Navigate to Project

```bash
cd /Users/shaansisodia/DEV/client-projects/lumelle
```

### Step 2: Start and End a Session

Just:
1. Open Claude Code in this directory (or use it here)
2. Do any small task
3. Exit the session (Ctrl+D or `/exit`)

### Step 3: Check What Was Created

**Immediately (after session ends):**
```bash
# Check session folder
ls -la blackbox5/5-project-memory/lumelle/operations/sessions/

# Check latest session structure
LATEST=$(ls -t blackbox5/5-project-memory/lumelle/operations/sessions/ | head -1)
ls -la "blackbox5/5-project-memory/lumelle/operations/sessions/$LATEST"
```

**Should see:**
```
session-{timestamp}/
├── transcript.jsonl
├── context.json
├── metrics.json
└── README.md
```

**Check timeline:**
```bash
cat blackbox5/5-project-memory/lumelle/project/timeline.yaml | grep -A5 "events:"
```

**Check reflection (after ~30s):**
```bash
sleep 35
ls -la blackbox5/5-project-memory/lumelle/operations/reflections/
```

---

## Expected Results

### Immediate (SessionEnd hooks)
✅ Session folder created: `operations/sessions/session-{unix_timestamp}/`
✅ JSON files: `context.json`, `metrics.json`, `transcript.jsonl`
✅ Timeline updated: New event added to `events: []` array
✅ README.md created with session summary
✅ Session log updated: `operations/session-log.txt`

### Test Results (2026-01-26)
✅ **create-session-record.sh**: Working correctly
  - Creates session folder with proper structure
  - Generates context.json with git branch, changes count, duration
  - Generates metrics.json with session stats
  - Copies transcript if provided
  - Creates README.md with session summary
  - Updates session-log.txt

✅ **update-timeline.sh**: Working correctly
  - Adds session event to timeline.yaml events array
  - Uses proper timestamp format
  - Fallback works when yq is not installed

### Async (Stop hook with Haiku)
✅ Reflection created: `operations/reflections/reflection_{unix_timestamp}.md`
✅ Contains 2-3 sentence reflection
✅ Generated by Haiku (cheap, fast model)

---

## Troubleshooting

### Hook Not Running

Check settings.json:
```bash
cat blackbox5/.claude/settings.json | jq '.hooks.SessionEnd'
```

### Session Folder Not Created

Check hook is executable:
```bash
ls -la blackbox5/.claude/hooks/create-session-record.sh
```

Should show `-rwxr-xr-x`.

### Wrong Memory Path

```bash
cat blackbox5/.claude/settings.json | jq '.env.BLACKBOX5_MEMORY_PATH'
```

For lumelle project, should be `./blackbox5/5-project-memory/lumelle`.

### Timeline Not Updating

Check if yq is installed:
```bash
which yq
```

If not installed, hook uses fallback append method.

---

## Cost Savings

**Old**: Everything with Sonnet 4.5 (~$50/day for 100 sessions)
**New**: Shell hooks (free) + Haiku for reflections (~$5/day for 100 sessions)

**Savings**: ~90% cost reduction

---

## Scalability Test

This design scales to 100+ agents:
- ✅ Fast shell hooks don't block
- ✅ Async AI hooks use cheap model
- ✅ Structured JSON easy to parse
- ✅ Clear separation (sessions now, reflections later)
