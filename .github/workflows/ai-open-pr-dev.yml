name: AI Open PR to dev (vk/*)

on:
  push:
    branches:
      - "vk/**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-open-pr-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  open_pr:
    name: Ensure PR exists (vk/* -> dev)
    runs-on: ubuntu-latest
    steps:
      - name: Create PR to dev if missing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ref = (context.ref || "").replace("refs/heads/", "");

            // Safety gate: only act on vk/* branches.
            if (!ref.startsWith("vk/")) {
              core.info(`Branch '${ref}' is not vk/*; skipping.`);
              return;
            }

            const base = "dev";
            const head = `${owner}:${ref}`;

            // If a PR already exists, just ensure it's labeled.
            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              base,
              head,
              per_page: 20,
            });

            if (existing.data.length > 0) {
              const pr = existing.data[0];
              core.info(`PR already exists: #${pr.number}`);

              // Ensure 'automerge' label exists so the auto-merge workflow will pick it up.
              const labels = new Set((pr.labels || []).map(l => l.name));
              if (!labels.has("automerge") && !labels.has("ai-automerge")) {
                core.info(`Adding 'automerge' label to existing PR #${pr.number}`);
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: pr.number,
                  labels: ["automerge"],
                });
              }
              return;
            }

            const title = `AI: ${ref} â†’ ${base}`;
            const body = [
              "Automated PR opened from a `vk/*` worker branch.",
              "",
              "Black Box requirements:",
              "- Update tracker: `docs/06-quality/feedback/ui-issue-tracker/ui-issue-tracker.md`",
              "- Update worklog in `docs/06-quality/feedback/ui-issue-tracker/ui-issues/`",
              "- When DONE: set tracker status to `DONE` and move worklog to `done-issues/`",
              "",
              "Merge policy: Auto-merge should activate after required checks pass.",
            ].join("\n");

            core.info(`Creating PR from ${head} to ${base}`);
            const created = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title,
              body,
              draft: false,
            });

            core.info(`Created PR #${created.data.number}`);

            // Ensure it is eligible for auto-merge workflow.
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: created.data.number,
              labels: ["automerge"],
            });
