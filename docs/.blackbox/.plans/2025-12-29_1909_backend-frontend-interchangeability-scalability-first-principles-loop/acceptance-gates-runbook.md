# Acceptance Gates Runbook (CLI, docs-only)

Goal: make “frontend is swappable / backend is stable” enforceable by running a small set of repeatable CLI checks and saving evidence under `artifacts/snapshots/`.

Evidence policy for this runbook:
- Every gate writes an output file into:  
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/`
- Every gate has a “what good looks like” baseline defined by an existing snapshot file (or by “diff goes down over time”).

Evidence anchor (existing gate list draft):  
- `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/plan-acceptance-gates.md.head120.txt`

---

## Setup (one time per session)

- From `docs/`:
  - `PLAN=".blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop"`
  - `SNP="$PLAN/artifacts/snapshots"`

- Refresh snapshot index (helps humans find outputs quickly):
  - `ls -la "$SNP" > "$SNP/_snapshot-index.ls.txt"`
  - Evidence anchor (snapshot index exists):  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/_snapshot-index.ls.txt`

Notes:
- The one-command refresh scripts now write timestamped logs into `artifacts/snapshots/` for traceability, plus `*.latest.log.txt` convenience copies:
  - `refresh-1909-all-gates.<timestamp>.log.txt` and `refresh-1909-all-gates.latest.log.txt`
  - `refresh-1909-contract-evidence.<timestamp>.log.txt` and `refresh-1909-contract-evidence.latest.log.txt`
  - `refresh-1909-stop-point-dashboard.<timestamp>.log.txt` and `refresh-1909-stop-point-dashboard.latest.log.txt`

---

## Gate A — Canonical backend boundary exists (`functions/api/**` Fetch-style handlers)

- Command:
  - `rg -n "^export const onRequest" ../functions/api > "$SNP/functions-api-handlers.clean.rg.txt" || true`
- What good looks like:
  - File is non-empty and only contains paths under `../functions/api/**`.
  - Baseline evidence:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/functions-api-handlers.clean.rg.txt`

- Command (route inventory):
  - `find ../functions/api -type f | sed 's|^../||' | sort > "$SNP/functions-api-files.clean.find.txt"`
- What good looks like:
  - List is stable-ish over time; diffs explain deliberate API changes.
  - Baseline evidence:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/functions-api-files.clean.find.txt`

---

## Gate A.0b — Checkout proxy seam exists (vendor-agnostic handoff)

Why this gate exists:
- The UI should not need to know Shopify checkout domains or route rules.
- The repo already has first-party proxy routes (`/cart/c/*`, `/checkouts/*`) and this gate keeps that seam from regressing.

Command (recommended):
- `./.blackbox/scripts/refresh-1909-all-gates.sh`

Evidence outputs (auto-captured by the refresh script):
- `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/functions-cart-c-catchall.ts.head200.txt`
- `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/functions-checkouts-catchall.ts.head200.txt`
- `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/functions-_lib-shopifyCheckoutProxy.ts.head240.txt`

What good looks like:
- All three evidence files exist and show consistent proxy/handoff behavior.

---

## Gate A.1 — Backend surface drift stays visible (legacy `api/**` vs canonical `functions/api/**`)

Why this gate exists:
- The repo currently contains a full legacy `api/**` route tree alongside `functions/**`. If both evolve independently, the `/api/*` contract will drift.

Command (recommended):
- `./.blackbox/scripts/refresh-1909-all-gates.sh`

What good looks like:
- Drift stays visible and trending in the right direction:
  - `api_only` decreases toward 0 as required endpoints are migrated into `functions/api/**`.
  - Eventually, `api/**` is deleted/archived once production is Cloudflare-only.

Evidence:
- Drift summary:  
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/api-vs-functions.summary.txt`
- Api-only endpoints:  
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/api-only-endpoints.txt`
- Api-only usage triage (auto-generated by `refresh-1909-all-gates.sh`):
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/api-only-endpoints.exact-usage.latest.txt`
- Api-only handler heads bundle (auto-generated by `refresh-1909-all-gates.sh`):
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/api-only-endpoints.handlers.head80.txt`

---

## Gate B — UI/client must not import provider adapters directly

- Command (repo-wide):
  - `rg -n "@platform/.*/adapters" ../src > "$SNP/boundary-adapter-imports.rg.txt" || true`
- What good looks like:
  - Empty output (or only platform runtime/adapters referencing adapters).
  - Baseline evidence (currently empty):  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/boundary-adapter-imports.rg.txt`

- Command (strict: UI + client domains only):
  - `rg -n "domains/platform/.*/adapters" ../src/ui ../src/domains/client > "$SNP/boundary-adapter-imports.ui-client.rg.txt" || true`
- What good looks like:
  - Empty output.
  - Baseline evidence (currently empty):  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/boundary-adapter-imports.ui-client.rg.txt`

---

## Gate C — “Vendor leaks” above adapters (report-only today; hard gate later)

- Command:
  - `./.blackbox/scripts/check-vendor-leaks.sh > "$SNP/check-vendor-leaks.txt" || true`
- What good looks like:
  - Today: this is a *baseline report*; over time we drive `disallowed_lines` → `0`.
  - Current baseline evidence:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/check-vendor-leaks.txt`
  - Script existence evidence:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/docs-blackbox-scripts-dir.ls.txt`

---

## Gate D — “Ports → runtimes → adapters” inventory remains coherent

- Command (ports):
  - `find ../src/domains/platform -path '*ports*' -type f | sed 's|^../||' | sort > "$SNP/platform-ports-files.txt"`
- What good looks like:
  - The file list exists and grows intentionally (ports are the contract surface).
  - Baseline evidence:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/platform-ports-files.txt`

- Command (runtimes):
  - `find ../src/domains/platform -name 'runtime.ts' -type f | sed 's|^../||' | sort > "$SNP/platform-runtime-files.txt"`
- What good looks like:
  - Runtime selection stays centralized (one per swappable component).
  - Baseline evidence:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/platform-runtime-files.txt`

- Command (adapters):
  - `find ../src/domains/platform -path '*adapters*' -type f | sed 's|^../||' | sort > "$SNP/platform-adapters-files.txt"`
- What good looks like:
  - Adapters are the only place vendor-specific code should grow.
  - Baseline evidence:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/platform-adapters-files.txt`

---

## Gate E — Vendor SDK imports stay isolated (report-only)

Why this gate exists:
- “Frontend is swappable” doesn’t require **zero** vendor SDK usage, but it does require that vendor SDK usage is:
  - intentional,
  - localized,
  - and not the default way features are implemented.
- This gate keeps drift visible as the UI grows (especially when adding embedded flows).

Command (recommended):
- `./.blackbox/scripts/refresh-1909-all-gates.sh`

Evidence output (auto-captured by the refresh script):
- `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/boundary-vendor-sdk-imports.nonplatform.rg.txt`

What good looks like:
- The file exists and the match set stays small.
- Every match is either:
  - identity UI dependency (auth UI), or
  - explicit embedded payment UI behind capabilities/flags, or
  - a flagged migration target with an associated plan.

---

## Gate F — Storefront boundary DTO neutrality (future; enable after PR10)

Why this gate exists:
- Storefront UI becomes truly swappable only when storefront responses are provider-neutral DTOs (no Shopify IDs, no Shopify object shapes required).
- This gate is the runtime enforcement counterpart of:
  - `storefront-contract-dto-mapping-v0.1.md`
  - `pr-10-storefront-dto-normalization-detailed-plan.md`

When to run:
- During PR10 (or any PR that changes storefront boundary response shapes).

Command (example; adjust host/handle/cart):
- Save a response snapshot and grep for Shopify GIDs:
  - `curl -sS \"https://<tenant-domain>/api/storefront/v2/product/by-handle?handle=<handle>\" > \"$SNP/storefront-v2-product.response.$(date -u +%Y-%m-%d_%H%M%S).json\"`
  - `rg -n \"gid://shopify/\" \"$SNP/storefront-v2-product.response.\"*.json > \"$SNP/storefront-v2-product.gid-leaks.$(date -u +%Y-%m-%d_%H%M%S).txt\" || true`

What good looks like:
- The `*.gid-leaks.*.txt` output is empty for all v2 storefront endpoints.

Notes:
- This is intentionally a runtime check (code scans can be misleading).
- For carts, prefer using a deterministic fixture cart/cartKey in a sandbox tenant so the check is reproducible.
