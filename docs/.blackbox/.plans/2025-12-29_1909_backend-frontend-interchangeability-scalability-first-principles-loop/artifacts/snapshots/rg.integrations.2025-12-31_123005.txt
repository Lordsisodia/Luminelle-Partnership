api/internal/recovery-cron.ts:5:  // TODO: hook into Supabase + Resend; for now, return not implemented.
api/customer/order.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/customer/order.ts:5:function getCookie(req: VercelRequest, name: string) {
api/customer/order.ts:19:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/customer/order.ts:23:  const shop = process.env.SHOPIFY_STORE_DOMAIN || ''
api/customer/order.ts:27:  const discover = await fetch(`https://${shop}/.well-known/shopify/customer-account-api/unstable`).then(r => r.json()).catch(() => null)
server/README.md:6:- `server/migrations/*` — SQL migrations intended to be run in Supabase (e.g. via Supabase SQL editor or `psql`).
server/README.md:12:- Shopify webhooks: `api/shopify/webhooks/*`
functions/api/customer/order.ts:13:  const shop = env.SHOPIFY_STORE_DOMAIN || ''
functions/api/customer/order.ts:18:  const discover = await fetch(`https://${shop}/.well-known/shopify/customer-account-api/unstable`)
api/_lib/db.ts:13:export async function ensureShopifySessionTable() {
api/_lib/db.ts:15:  // Minimal session store for Shopify offline tokens (used by /api/shopify/auth/callback and admin helpers).
api/_lib/db.ts:30:  await ensureShopifySessionTable()
api/customer/orders.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/customer/orders.ts:3:function getCookie(req: VercelRequest, name: string) {
api/customer/orders.ts:9:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/customer/orders.ts:10:  const shop = process.env.SHOPIFY_STORE_DOMAIN || ''
api/customer/orders.ts:17:  const discover = await fetch(`https://${shop}/.well-known/shopify/customer-account-api/unstable`).then(r => r.json()).catch(() => null)
functions/api/customer/orders.ts:9:  const shop = env.SHOPIFY_STORE_DOMAIN || ''
functions/api/customer/orders.ts:15:  const discover = await fetch(`https://${shop}/.well-known/shopify/customer-account-api/unstable`)
api/shopify/sync.ts:2:import { handleSyncForShop } from "../_lib/shopifyCore.js";
src/lib/supabase.ts:1:export { createSupabaseClient, isSupabaseConfigured, supabase } from '@platform/storage/supabase'
api/test.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node';
api/test.ts:3:export default function handler(req: VercelRequest, res: VercelResponse) {
api/webhooks/clerk.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/webhooks/clerk.ts:7:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/auth.ts:6:  return /^(?:[a-z0-9][a-z0-9-]*)\.myshopify\.com$/i.test(shop);
api/shopify/auth.ts:17:  const apiKey = process.env.SHOPIFY_API_KEY;
api/shopify/auth.ts:18:  const scopes = process.env.SCOPES || process.env.SHOPIFY_SCOPES || "read_products,write_products";
api/shopify/auth.ts:19:  const appUrl = process.env.SHOPIFY_APP_URL || url.origin;
api/shopify/auth.ts:20:  const callback = new URL("/api/shopify/auth/callback", appUrl).toString();
api/shopify/auth.ts:34:    `shopify_state=${state}; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=600`,
api/shopify/auth.ts:38:    `shopify_shop=${shop}; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=600`,
api/shopify/billing/create.ts:1:import { ensureShopifySessionTable, getPgPool } from "../../_lib/db.js";
api/shopify/billing/create.ts:3:const API_VERSION = process.env.SHOPIFY_API_VERSION || "2025-01";
api/shopify/billing/create.ts:12:  await ensureShopifySessionTable()
api/shopify/billing/create.ts:21:  const returnUrl = new URL("/shopify/app", url.origin);
api/shopify/billing/create.ts:29:      "X-Shopify-Access-Token": token,
server/migrations/2025-12-16_cms_globals_pdp_spin_wheel.sql:1:-- Store Spin Wheel (welcome wheel) copy in Supabase so PDP has zero hard-coded strings
functions/api/orders/by-name.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/orders/by-name.ts:14:  const supabase = getSupabase(env)
functions/api/orders/by-name.ts:15:  const { data, error } = await supabase.from('ShopOrders').select('*').eq('name', name).limit(1)
api/shopify/webhooks/customers-data-request.ts:4:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/customers-data-request.ts:8:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/customers-data-request.ts:11:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string
server/migrations/2025-12-14_shopify_tables_and_metrics.sql:1:-- Shopify sync tables + analytics RPCs (for Cloudflare Pages Functions / Workers)
server/migrations/2025-12-14_shopify_tables_and_metrics.sql:3:-- NOTE: Table names intentionally match existing Vercel/pg code:
server/migrations/2025-12-14_shopify_tables_and_metrics.sql:69:-- Analytics RPCs (called from Cloudflare Functions via Supabase `rpc()`)
server/migrations/2025-12-16_cms_products_seed_from_product_config.sql:43:    'gid://shopify/ProductVariant/56829020504438',
server/migrations/2025-12-16_cms_products_seed_from_product_config.sql:188:    'gid://shopify/ProductVariant/56852779696502',
functions/api/orders/by-email.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/orders/by-email.ts:13:  const supabase = getSupabase(env)
functions/api/orders/by-email.ts:14:  const { data, error } = await supabase
api/_lib/orders.ts:26:  // Map Shopify status to internal OrderStatus
api/_lib/orders.ts:48:    events: JSON.stringify([{ at: new Date().toISOString(), message: 'Order synced from Shopify' }]),
api/shopify/webhooks/checkouts-create.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/checkouts-create.ts:7:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/checkouts-create.ts:17:    console.log('Received Shopify Checkout Create Webhook')
server/migrations/2025-12-11_experiments.sql:2:-- Note: adjust auth/role names to match your Supabase project. Service inserts only; readonly selects via reporting role.
server/migrations/2025-12-11_experiments.sql:91:-- allow inserts from Supabase service role only
functions/api/orders/get.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/orders/get.ts:13:  const supabase = getSupabase(env)
functions/api/orders/get.ts:14:  const { data, error } = await supabase.from('ShopOrders').select('*').eq('order_id', id).limit(1)
server/migrations/2025-12-14_customers_table.sql:1:-- Unified customers table (Clerk + Shopify app usage)
server/migrations/2025-12-14_customers_table.sql:2:-- This matches the schema expected by `api/_lib/customers.ts` and Cloudflare Functions `functions/_lib/customers.ts`.
server/migrations/2025-12-14_shopify_rls_lockdown.sql:1:-- Lock down Shopify sync tables (PII + tokens) via RLS.
server/migrations/2025-12-14_shopify_rls_lockdown.sql:3:-- These tables are written/read by server-only code (Cloudflare Pages Functions / Workers) using the
server/migrations/2025-12-14_shopify_rls_lockdown.sql:4:-- Supabase `service_role` key, which bypasses RLS.
server/migrations/2025-12-14_shopify_rls_lockdown.sql:6:-- Important: Without RLS, these tables would be accessible via the public Supabase anon key.
api/shopify/webhooks/fulfillments-create.ts:6:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/fulfillments-create.ts:38:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/fulfillments-create.ts:41:  const deliveryId = (req.headers['x-shopify-delivery-id'] || '') as string
api/shopify/webhooks/fulfillments-create.ts:43:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string
api/shopify/webhooks/fulfillments-create.ts:105:          [userId, order?.email ?? attrs.lumelle_user_email ?? null, JSON.stringify({ source: 'shopify_webhook' })],
api/shopify/webhooks/fulfillments-create.ts:113:            `shopify:fulfillment:${shop}:${orderId}`,
api/shopify/webhooks/fulfillments-create.ts:120:              shopify_delivery_id: deliveryId || null,
api/shopify/webhooks/fulfillments-create.ts:130:    // Let Shopify retry if needed (awardKey is idempotent, and deliveryId is already marked)
api/_lib/README.md:2:Express webhook/dev server for local integration tests (Shopify/Clerk/Supabase). Not shipped to the client bundle. Keep API logic domain-agnostic; per-domain handlers should live with the domain and be imported here.
src/lib/utils/cdn.ts:16:  // TEMP: The Supabase CDN bucket is missing the shower-cap spotlight image,
api/shopify/webhooks/checkouts-update.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/checkouts-update.ts:7:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/checkouts-update.ts:17:    console.log('Received Shopify Checkout Update Webhook')
api/shopify/webhooks/_verify.ts:2:import type { VercelRequest } from '@vercel/node';
api/shopify/webhooks/_verify.ts:4:export async function verifyWebhook(req: VercelRequest, secret = process.env.SHOPIFY_WEBHOOK_SECRET || process.env.SHOPIFY_API_SECRET || "") {
api/shopify/webhooks/_verify.ts:5:  const hmacHeader = (req.headers["x-shopify-hmac-sha256"] || "") as string;
src/content/legal.ts:25:Payouts are issued weekly via Stripe using the bank information you provide in onboarding.`,
functions/api/experiment/config.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/experiment/config.ts:8:  const supabase = getSupabase(env)
functions/api/experiment/config.ts:9:  const { data, error } = await supabase
src/lib/product.ts:20:  // Legacy placeholder; replaced when Shopify is configured and callers use `fetchProductByHandle`.
functions/api/experiment/track.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/experiment/track.ts:40:  const supabase = getSupabase(env)
functions/api/experiment/track.ts:43:    const { error } = await supabase.from('experiment_exposures').insert(exposures)
functions/api/experiment/track.ts:48:    const { error } = await supabase.from('events').insert(events)
api/shopify/webhooks/orders-create.ts:7:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/orders-create.ts:24:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/orders-create.ts:27:  const deliveryId = (req.headers['x-shopify-delivery-id'] || '') as string
api/shopify/webhooks/orders-create.ts:29:  const shop = (req.headers['x-shopify-shop-domain'] || body?.shop_domain || body?.domain) as string
api/shopify/webhooks/orders-create.ts:47:          source: 'shopify_webhook',
api/shopify/webhooks/orders-create.ts:50:          shopify_delivery_id: deliveryId || undefined,
functions/api/exports/orders.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/exports/orders.ts:33:  const supabase = getSupabase(env)
functions/api/exports/orders.ts:34:  const { data, error } = await supabase
api/_lib/customers.ts:26:  // Handle both Shopify (numeric) and Clerk (string) IDs
api/shopify/webhooks/app-uninstalled.ts:2:import { handleAppUninstalled } from "../../_lib/shopifyCore.js";
api/shopify/webhooks/app-uninstalled.ts:4:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/app-uninstalled.ts:8:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/app-uninstalled.ts:12:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain || body?.shop) as string
functions/api/exports/customers.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/exports/customers.ts:21:  const supabase = getSupabase(env)
functions/api/exports/customers.ts:22:  const { data, error } = await supabase
api/shopify/webhooks/customers-redact.ts:4:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/customers-redact.ts:8:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/customers-redact.ts:11:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string
src/hooks/useSyncUserToSupabase.ts:3:import { createSupabaseClient, supabase } from '@platform/storage/supabase'
src/hooks/useSyncUserToSupabase.ts:20:export const useSyncUserToSupabase = () => {
src/hooks/useSyncUserToSupabase.ts:47:      const token = await getToken({ template: 'supabase' }).catch(() => null)
src/hooks/useSyncUserToSupabase.ts:48:      const client = token ? createSupabaseClient(token) : supabase
src/hooks/useSyncUserToSupabase.ts:52:        console.error('Failed to sync Clerk user to Supabase', error)
api/shopify/webhooks/shop-redact.ts:4:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/shop-redact.ts:8:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/shop-redact.ts:11:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string
functions/api/shopify/auth.ts:4:import { isValidShopDomain } from '../../_lib/shopifyOAuth'
functions/api/shopify/auth.ts:15:  const apiKey = env.SHOPIFY_API_KEY || ''
functions/api/shopify/auth.ts:16:  const scopes = env.SCOPES || env.SHOPIFY_SCOPES || 'read_products,write_products'
functions/api/shopify/auth.ts:17:  const appUrl = env.SHOPIFY_APP_URL || url.origin
functions/api/shopify/auth.ts:18:  const callback = new URL('/api/shopify/auth/callback', appUrl).toString()
functions/api/shopify/auth.ts:32:    `shopify_state=${state}; ${cookieBase}`,
functions/api/shopify/auth.ts:33:    `shopify_shop=${shop}; ${cookieBase}`,
api/shopify/webhooks/products_create.ts:4:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/products_create.ts:8:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/products_create.ts:16:    // const hmac = req.headers.get("X-Shopify-Hmac-Sha256"); // No longer needed directly here
api/shopify/webhooks/products_create.ts:17:    const secret = process.env.SHOPIFY_API_SECRET;
api/shopify/webhooks/products_create.ts:20:        console.error("SHOPIFY_API_SECRET is not set");
api/shopify/webhooks/products_create.ts:29:    const topic = (req.headers['x-shopify-topic'] || '') as string;
api/shopify/webhooks/products_create.ts:30:    const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string;
api/shopify/webhooks/products_create.ts:38:    // Map Shopify product to our schema
api/shopify/webhooks/products_create.ts:39:    // id is uuid in our DB, but Shopify ID is a number (e.g. 123456789)
api/shopify/webhooks/products_create.ts:40:    // We might need to store Shopify ID in a separate column or use a deterministic UUID based on Shopify ID
api/shopify/webhooks/products_create.ts:41:    // For now, let's assume we check if a product with this SKU exists, or we need to add a shopify_id column to products table.
api/shopify/webhooks/products_create.ts:43:    // It doesn't have shopify_id.
api/shopify/webhooks/products_create.ts:46:    const sku = product.variants?.[0]?.sku || `SHOPIFY-${product.id}`;
functions/api/shopify/webhooks/customers-data-request.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/customers-data-request.ts:9:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/customers-data-request.ts:13:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/customers-data-request.ts:14:    request.headers.get('X-Shopify-Shop-Domain') ||
api/shopify/webhooks/orders-updated.ts:7:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/orders-updated.ts:39:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/orders-updated.ts:42:  const deliveryId = (req.headers['x-shopify-delivery-id'] || '') as string
api/shopify/webhooks/orders-updated.ts:50:  const shop = (req.headers['x-shopify-shop-domain'] || body?.shop_domain || body?.domain) as string
api/shopify/webhooks/orders-updated.ts:92:            [userId, order?.email ?? attrs.lumelle_user_email ?? null, JSON.stringify({ source: 'shopify_webhook' })],
api/shopify/webhooks/orders-updated.ts:95:          const awardSource = `shopify:fulfillment:${shop}:${orderId}`
api/shopify/webhooks/orders-updated.ts:110:                `shopify:refund:${shop}:${orderId}`,
api/shopify/webhooks/orders-updated.ts:127:      // Let Shopify retry (deliveryId is already marked)
functions/api/customer-auth/start.ts:10:  const shop = (url.searchParams.get('shop') || env.SHOPIFY_STORE_DOMAIN || '').trim()
functions/_lib/shopOrders.ts:2:import { getSupabase } from './supabase'
functions/_lib/shopOrders.ts:30:  const supabase = getSupabase(env)
functions/_lib/shopOrders.ts:60:  const { error } = await supabase.from('ShopOrders').upsert([record], { onConflict: 'shop,order_id' })
functions/_lib/shopOrders.ts:70:  const supabase = getSupabase(env)
functions/_lib/shopOrders.ts:76:  const { error } = await supabase.from('ShopOrders').update(update).eq('shop', shop).eq('order_id', orderId)
functions/api/shopify/webhooks/fulfillments-create.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/fulfillments-create.ts:4:import { getSupabase } from '../../../_lib/supabase'
functions/api/shopify/webhooks/fulfillments-create.ts:32:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/fulfillments-create.ts:36:    request.headers.get('x-shopify-delivery-id') ||
functions/api/shopify/webhooks/fulfillments-create.ts:37:    request.headers.get('x-shopify-webhook-id') ||
functions/api/shopify/webhooks/fulfillments-create.ts:38:    request.headers.get('X-Shopify-Webhook-Id') ||
functions/api/shopify/webhooks/fulfillments-create.ts:43:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/fulfillments-create.ts:44:    request.headers.get('X-Shopify-Shop-Domain') ||
functions/api/shopify/webhooks/fulfillments-create.ts:60:  const supabase = getSupabase(env)
functions/api/shopify/webhooks/fulfillments-create.ts:61:  const { data: existing, error: readError } = await supabase
functions/api/shopify/webhooks/fulfillments-create.ts:79:    const { error: updateError } = await supabase
functions/api/shopify/webhooks/fulfillments-create.ts:106:      await supabase.from('customers').upsert(
functions/api/shopify/webhooks/fulfillments-create.ts:107:        [{ id: userId, email: existing?.email ?? attrs.lumelle_user_email ?? null, updated_at: new Date().toISOString(), raw: { source: 'shopify_webhook' } }],
functions/api/shopify/webhooks/fulfillments-create.ts:111:      const { error: insertError } = await supabase.from('loyalty_points_ledger').insert([
functions/api/shopify/webhooks/fulfillments-create.ts:115:          source: `shopify:fulfillment:${shop}:${orderId}`,
functions/api/shopify/webhooks/fulfillments-create.ts:122:            shopify_delivery_id: deliveryId || null,
api/shopify/webhooks/customers-update.ts:4:import { VercelRequest, VercelResponse } from '@vercel/node';
api/shopify/webhooks/customers-update.ts:8:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/customers-update.ts:11:  const deliveryId = (req.headers['x-shopify-delivery-id'] || '') as string;
api/shopify/webhooks/customers-update.ts:14:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string;
functions/api/shopify/webhooks/orders-create.ts:25:    request.headers.get('x-shopify-hmac-sha256')?.trim() || request.headers.get('X-Shopify-Hmac-Sha256')?.trim() || ''
functions/api/shopify/webhooks/orders-create.ts:31:  // Shopify signs webhook payloads with the app secret (`SHOPIFY_API_SECRET`).
functions/api/shopify/webhooks/orders-create.ts:32:  // Some deployments historically used a separate env var name (`SHOPIFY_WEBHOOK_SECRET`) which
functions/api/shopify/webhooks/orders-create.ts:34:  const apiSecret = env.SHOPIFY_API_SECRET || ''
functions/api/shopify/webhooks/orders-create.ts:35:  const webhookSecret = env.SHOPIFY_WEBHOOK_SECRET || ''
functions/api/shopify/webhooks/orders-create.ts:36:  if (!apiSecret && !webhookSecret) return text('Missing Shopify webhook secret', { status: 500 })
functions/api/shopify/webhooks/orders-create.ts:53:  const deliveryId = request.headers.get('x-shopify-delivery-id')?.trim() || ''
functions/api/shopify/webhooks/orders-create.ts:55:  const shop = (request.headers.get('x-shopify-shop-domain') || body?.shop_domain || body?.domain || '').toString()
functions/api/shopify/webhooks/orders-create.ts:71:      // Do the network call after returning 200 to Shopify (reduce retries / timeouts).
functions/api/shopify/webhooks/orders-create.ts:78:            source: 'shopify_webhook',
functions/api/shopify/webhooks/orders-create.ts:80:            shopify_delivery_id: deliveryId || undefined,
api/shopify/webhooks/customers-delete.ts:5:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/customers-delete.ts:9:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/customers-delete.ts:12:  const deliveryId = (req.headers['x-shopify-delivery-id'] || '') as string
api/shopify/webhooks/customers-delete.ts:14:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string
functions/_lib/shopifyCheckoutProxy.ts:8:    (env.SHOPIFY_CHECKOUT_UPSTREAM_DOMAIN as string | undefined) ||
functions/_lib/shopifyCheckoutProxy.ts:9:    (env.SHOPIFY_STORE_DOMAIN as string | undefined) ||
functions/_lib/shopifyCheckoutProxy.ts:10:    (env.VITE_SHOPIFY_STORE_DOMAIN as string | undefined)
functions/_lib/shopifyCheckoutProxy.ts:55:          You’re on a Shopify checkout/cart link:
functions/_lib/shopifyCheckoutProxy.ts:61:          This site is hosted as a headless app on <code>${escapeHtml(currentHost)}</code>, but Shopify is currently issuing checkout URLs on that same host.
functions/_lib/shopifyCheckoutProxy.ts:62:          To make a proxy work, Shopify must serve checkout pages from an upstream domain (usually <code>…myshopify.com</code>) that does <em>not</em> redirect back here.
functions/_lib/shopifyCheckoutProxy.ts:66:          Fix: In Shopify Admin → <strong>Settings → Domains</strong>, set the store’s <strong>primary domain</strong> to <code>${upstream}</code>
functions/_lib/shopifyCheckoutProxy.ts:67:          (or to a dedicated Shopify subdomain like <code>shop.${escapeHtml(currentHost)}</code>), then try again.
functions/_lib/shopifyCheckoutProxy.ts:100:export async function proxyShopifyCheckout(context: PagesContext<Env & Record<string, unknown>>): Promise<Response> {
functions/_lib/shopifyCheckoutProxy.ts:127:        reason: 'Missing SHOPIFY_CHECKOUT_UPSTREAM_DOMAIN / SHOPIFY_STORE_DOMAIN in Pages environment variables.',
functions/_lib/shopifyCheckoutProxy.ts:159:  // If Shopify is redirecting back to the current host, the proxy cannot complete until Shopify domains are adjusted.
functions/_lib/shopifyCheckoutProxy.ts:171:            reason: `Shopify redirected upstream checkout request back to ${currentHost} (${redirectReason}).`,
functions/api/shopify/webhooks/app-uninstalled.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/app-uninstalled.ts:4:import { getSupabase } from '../../../_lib/supabase'
functions/api/shopify/webhooks/app-uninstalled.ts:9:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/app-uninstalled.ts:13:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/app-uninstalled.ts:14:    request.headers.get('X-Shopify-Shop-Domain') ||
functions/api/shopify/webhooks/app-uninstalled.ts:22:    const supabase = getSupabase(env)
functions/api/shopify/webhooks/app-uninstalled.ts:23:    await supabase.from('Session').delete().eq('id', `offline_${shop}`)
functions/cart/c/[[catchall]].ts:2:import { proxyShopifyCheckout } from '../../_lib/shopifyCheckoutProxy'
functions/cart/c/[[catchall]].ts:4:export const onRequest: PagesFunction = (context) => proxyShopifyCheckout(context as any)
functions/api/shopify/webhooks/customers-redact.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/customers-redact.ts:9:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/customers-redact.ts:13:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/customers-redact.ts:14:    request.headers.get('X-Shopify-Shop-Domain') ||
api/shopify/webhooks/customers-create.ts:5:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/webhooks/customers-create.ts:9:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/webhooks/customers-create.ts:13:  const deliveryId = (req.headers['x-shopify-delivery-id'] || '') as string
api/shopify/webhooks/customers-create.ts:16:  const shop = (req.headers['x-shopify-shop-domain'] || body?.domain || body?.shop_domain) as string
functions/_lib/supabase.ts:1:import { createClient, type SupabaseClient } from '@supabase/supabase-js'
functions/_lib/supabase.ts:4:type Cached = { key: string; client: SupabaseClient }
functions/_lib/supabase.ts:7:export function getSupabase(env: Env) {
functions/_lib/supabase.ts:8:  const url = env.SUPABASE_URL
functions/_lib/supabase.ts:9:  const key = env.SUPABASE_SERVICE_ROLE_KEY
functions/_lib/supabase.ts:11:    throw new Error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY')
functions/api/shopify/webhooks/shop-redact.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/shop-redact.ts:4:import { getSupabase } from '../../../_lib/supabase'
functions/api/shopify/webhooks/shop-redact.ts:9:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/shop-redact.ts:13:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/shop-redact.ts:14:    request.headers.get('X-Shopify-Shop-Domain') ||
functions/api/shopify/webhooks/shop-redact.ts:19:  const supabase = getSupabase(env)
functions/api/shopify/webhooks/shop-redact.ts:20:  const { error } = await supabase.from('ShopCustomers').delete().eq('shop', String(shop))
functions/api/shopify/auth/callback.ts:4:import { verifyShopifyHmac } from '../../../_lib/shopifyOAuth'
functions/api/shopify/auth/callback.ts:5:import { getSupabase } from '../../../_lib/supabase'
functions/api/shopify/auth/callback.ts:17:  if (state !== getCookie(request, 'shopify_state')) return text('Invalid state', { status: 401 })
functions/api/shopify/auth/callback.ts:19:  const ok = await verifyShopifyHmac(env, url)
functions/api/shopify/auth/callback.ts:26:      client_id: env.SHOPIFY_API_KEY,
functions/api/shopify/auth/callback.ts:27:      client_secret: env.SHOPIFY_API_SECRET,
functions/api/shopify/auth/callback.ts:34:  const supabase = getSupabase(env)
functions/api/shopify/auth/callback.ts:35:  const { error } = await supabase.from('Session').upsert(
functions/api/shopify/auth/callback.ts:51:  const webhookUrlBase = env.SHOPIFY_APP_URL || url.origin
functions/api/shopify/auth/callback.ts:52:  const version = env.SHOPIFY_API_VERSION || '2025-10'
functions/api/shopify/auth/callback.ts:63:      headers: { 'content-type': 'application/json', 'X-Shopify-Access-Token': tokenJson.access_token },
functions/api/shopify/auth/callback.ts:69:    await createWebhook('CUSTOMERS_CREATE', '/api/shopify/webhooks/customers-create')
functions/api/shopify/auth/callback.ts:70:    await createWebhook('CUSTOMERS_UPDATE', '/api/shopify/webhooks/customers-update')
functions/api/shopify/auth/callback.ts:71:    await createWebhook('CUSTOMERS_DELETE', '/api/shopify/webhooks/customers-delete')
functions/api/shopify/auth/callback.ts:72:    await createWebhook('APP_UNINSTALLED', '/api/shopify/webhooks/app-uninstalled')
functions/api/shopify/auth/callback.ts:73:    await createWebhook('ORDERS_CREATE', '/api/shopify/webhooks/orders-create')
functions/api/shopify/auth/callback.ts:74:    await createWebhook('ORDERS_UPDATED', '/api/shopify/webhooks/orders-updated')
functions/api/shopify/auth/callback.ts:75:    await createWebhook('FULFILLMENTS_CREATE', '/api/shopify/webhooks/fulfillments-create')
functions/api/shopify/auth/callback.ts:82:    'shopify_state=; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=0',
functions/api/shopify/auth/callback.ts:83:    'shopify_shop=; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=0',
functions/api/shopify/auth/callback.ts:87:  headers.set('Location', `/shopify/app${hostPath}`)
api/shopify/session.ts:1:import { ensureShopifySessionTable, getPgPool } from "../_lib/db.js";
api/shopify/session.ts:8:  await ensureShopifySessionTable()
functions/api/shopify/webhooks/orders-updated.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/orders-updated.ts:6:import { getSupabase } from '../../../_lib/supabase'
functions/api/shopify/webhooks/orders-updated.ts:39:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/orders-updated.ts:43:    request.headers.get('x-shopify-delivery-id') ||
functions/api/shopify/webhooks/orders-updated.ts:44:    request.headers.get('x-shopify-webhook-id') ||
functions/api/shopify/webhooks/orders-updated.ts:45:    request.headers.get('X-Shopify-Webhook-Id') ||
functions/api/shopify/webhooks/orders-updated.ts:50:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/orders-updated.ts:51:    request.headers.get('X-Shopify-Shop-Domain') ||
functions/api/shopify/webhooks/orders-updated.ts:70:      const supabase = getSupabase(env)
functions/api/shopify/webhooks/orders-updated.ts:72:      const { data: order, error: orderError } = await supabase
functions/api/shopify/webhooks/orders-updated.ts:85:        await supabase.from('customers').upsert(
functions/api/shopify/webhooks/orders-updated.ts:86:          [{ id: userId, email: order.email ?? attrs.lumelle_user_email ?? null, updated_at: new Date().toISOString(), raw: { source: 'shopify_webhook' } }],
functions/api/shopify/webhooks/orders-updated.ts:90:        const awardSource = `shopify:fulfillment:${shop}:${orderId}`
functions/api/shopify/webhooks/orders-updated.ts:91:        const { data: awarded, error: awardError } = await supabase
functions/api/shopify/webhooks/orders-updated.ts:104:          const { error: insertError } = await supabase.from('loyalty_points_ledger').insert([
functions/api/shopify/webhooks/orders-updated.ts:108:              source: `shopify:refund:${shop}:${orderId}`,
functions/api/shopify/webhooks/customers-update.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/customers-update.ts:10:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/customers-update.ts:14:    request.headers.get('x-shopify-delivery-id') ||
functions/api/shopify/webhooks/customers-update.ts:15:    request.headers.get('x-shopify-webhook-id') ||
functions/api/shopify/webhooks/customers-update.ts:16:    request.headers.get('X-Shopify-Webhook-Id') ||
functions/api/shopify/webhooks/customers-update.ts:21:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/customers-update.ts:22:    request.headers.get('X-Shopify-Shop-Domain') ||
functions/api/shopify/webhooks/customers-delete.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/customers-delete.ts:10:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/customers-delete.ts:14:    request.headers.get('x-shopify-delivery-id') ||
functions/api/shopify/webhooks/customers-delete.ts:15:    request.headers.get('x-shopify-webhook-id') ||
functions/api/shopify/webhooks/customers-delete.ts:16:    request.headers.get('X-Shopify-Webhook-Id') ||
functions/api/shopify/webhooks/customers-delete.ts:21:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/customers-delete.ts:22:    request.headers.get('X-Shopify-Shop-Domain') ||
functions/_lib/types.ts:2:  // Supabase (server-side)
functions/_lib/types.ts:3:  SUPABASE_URL?: string
functions/_lib/types.ts:4:  SUPABASE_SERVICE_ROLE_KEY?: string
functions/_lib/types.ts:6:  // PostHog (server-side capture, e.g. Shopify webhooks → purchase)
functions/_lib/types.ts:13:  // Shopify (app + webhooks)
functions/_lib/types.ts:14:  SHOPIFY_STORE_DOMAIN?: string
functions/_lib/types.ts:15:  // Optional: explicitly choose the upstream host for checkout proxying (e.g. myshopify.com).
functions/_lib/types.ts:16:  // If omitted, falls back to SHOPIFY_STORE_DOMAIN / VITE_SHOPIFY_STORE_DOMAIN.
functions/_lib/types.ts:17:  SHOPIFY_CHECKOUT_UPSTREAM_DOMAIN?: string
functions/_lib/types.ts:18:  SHOPIFY_API_KEY?: string
functions/_lib/types.ts:19:  SHOPIFY_API_SECRET?: string
functions/_lib/types.ts:20:  SHOPIFY_ADMIN_API_ACCESS_TOKEN?: string
functions/_lib/types.ts:21:  SHOPIFY_API_VERSION?: string
functions/_lib/types.ts:22:  SHOPIFY_SCOPES?: string
functions/_lib/types.ts:24:  SHOPIFY_APP_URL?: string
functions/_lib/types.ts:25:  SHOPIFY_WEBHOOK_SECRET?: string
functions/_lib/types.ts:27:  // Shopify Storefront (private token used server-side)
functions/_lib/types.ts:28:  SHOPIFY_STOREFRONT_PRIVATE_TOKEN?: string
functions/_lib/types.ts:30:  // Shopify Customer Accounts
functions/_lib/types.ts:43:  // Stripe (server-side; future)
functions/_lib/types.ts:44:  STRIPE_SECRET_KEY?: string
functions/api/shopify/webhooks/customers-create.ts:3:import { verifyShopifyWebhook } from '../../../_lib/shopifyWebhooks'
functions/api/shopify/webhooks/customers-create.ts:10:  const { valid, body } = await verifyShopifyWebhook(request, env)
functions/api/shopify/webhooks/customers-create.ts:14:    request.headers.get('x-shopify-delivery-id') ||
functions/api/shopify/webhooks/customers-create.ts:15:    request.headers.get('x-shopify-webhook-id') ||
functions/api/shopify/webhooks/customers-create.ts:16:    request.headers.get('X-Shopify-Webhook-Id') ||
functions/api/shopify/webhooks/customers-create.ts:21:    request.headers.get('x-shopify-shop-domain') ||
functions/api/shopify/webhooks/customers-create.ts:22:    request.headers.get('X-Shopify-Shop-Domain') ||
functions/api/admin/orders/list.ts:2:import { getSupabase } from '../../../_lib/supabase'
functions/api/admin/orders/list.ts:104:  const supabase = getSupabase(env)
functions/api/admin/orders/list.ts:106:  let query = supabase
functions/api/shopify/session.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/shopify/session.ts:12:  const supabase = getSupabase(env)
functions/api/shopify/session.ts:13:  const { data, error } = await supabase.from('Session').select('id').eq('id', `offline_${shop}`).limit(1)
functions/api/admin/orders/get.ts:2:import { getSupabase } from '../../../_lib/supabase'
functions/api/admin/orders/get.ts:97:  const supabase = getSupabase(env)
functions/api/admin/orders/get.ts:101:  const { data, error } = await supabase
functions/_lib/storefront.ts:4:  const version = env.SHOPIFY_API_VERSION || '2025-10'
functions/_lib/storefront.ts:5:  const domain = env.SHOPIFY_STORE_DOMAIN
functions/_lib/storefront.ts:6:  const privateToken = env.SHOPIFY_STOREFRONT_PRIVATE_TOKEN
functions/_lib/storefront.ts:8:    throw new Error('Storefront private token or domain not set (SHOPIFY_STORE_DOMAIN/SHOPIFY_STOREFRONT_PRIVATE_TOKEN)')
functions/_lib/storefront.ts:19:      'X-Shopify-Storefront-Private-Token': privateToken,
functions/api/admin/sections/update.ts:4:import { adminGraphQL, getAdminToken } from '../../../_lib/shopifyAdmin'
functions/api/admin/sections/update.ts:14:  const shop = url.searchParams.get('shop') || env.SHOPIFY_STORE_DOMAIN || ''
functions/_lib/shopifyWebhooks.ts:4:export async function verifyShopifyWebhook(
functions/_lib/shopifyWebhooks.ts:8:  const hmacHeader = request.headers.get('x-shopify-hmac-sha256') || request.headers.get('X-Shopify-Hmac-Sha256')
functions/_lib/shopifyWebhooks.ts:11:  // Shopify signs webhook payloads with the app secret (`SHOPIFY_API_SECRET`).
functions/_lib/shopifyWebhooks.ts:12:  // Some deployments historically used a separate env var name (`SHOPIFY_WEBHOOK_SECRET`) which
functions/_lib/shopifyWebhooks.ts:14:  const apiSecret = env.SHOPIFY_API_SECRET || ''
functions/_lib/shopifyWebhooks.ts:15:  const webhookSecret = env.SHOPIFY_WEBHOOK_SECRET || ''
functions/api/admin/sections/get.ts:4:import { adminGraphQL, getAdminToken } from '../../../_lib/shopifyAdmin'
functions/api/admin/sections/get.ts:14:  const shop = url.searchParams.get('shop') || env.SHOPIFY_STORE_DOMAIN || ''
api/admin/media/delete.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/admin/media/delete.ts:2:import { createClient } from '@supabase/supabase-js'
api/admin/media/delete.ts:6:const { SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY } = process.env
api/admin/media/delete.ts:16:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/admin/media/delete.ts:17:  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
api/admin/media/delete.ts:18:    return res.status(500).json({ error: 'Supabase service env missing' })
api/admin/media/delete.ts:25:  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
api/admin/media/delete.ts:26:  const query = supabase.from('cms_product_media').delete().eq('public_id', public_id)
functions/_lib/customerAccounts.ts:20:    fetch(`https://${shop}/.well-known/shopify/customer-account-api/unstable`).then((r) => r.json()),
functions/_lib/shopifyAdmin.ts:2:import { getSupabase } from './supabase'
functions/_lib/shopifyAdmin.ts:6:  // This avoids having to run the Shopify OAuth install flow just to read/write admin metafields.
functions/_lib/shopifyAdmin.ts:7:  if (env.SHOPIFY_ADMIN_API_ACCESS_TOKEN) return env.SHOPIFY_ADMIN_API_ACCESS_TOKEN
functions/_lib/shopifyAdmin.ts:9:  const supabase = getSupabase(env)
functions/_lib/shopifyAdmin.ts:10:  const { data, error } = await supabase.from('Session').select('accesstoken').eq('id', `offline_${shop}`).limit(1).maybeSingle()
functions/_lib/shopifyAdmin.ts:24:  const version = env.SHOPIFY_API_VERSION || '2025-10'
functions/_lib/shopifyAdmin.ts:29:      'X-Shopify-Access-Token': token,
api/admin/media/list.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/admin/media/list.ts:2:import { createClient } from '@supabase/supabase-js'
api/admin/media/list.ts:4:const { SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY } = process.env
api/admin/media/list.ts:6:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/admin/media/list.ts:7:  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
api/admin/media/list.ts:8:    return res.status(500).json({ error: 'Supabase service env missing' })
api/admin/media/list.ts:15:  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
api/admin/media/list.ts:16:  const { data, error } = await supabase
api/shopify/_lib/verify.ts:4:  const secret = process.env.SHOPIFY_API_SECRET
api/shopify/_lib/verify.ts:6:    throw new Error('SHOPIFY_API_SECRET is not set')
functions/_lib/shopCustomers.ts:2:import { getSupabase } from './supabase'
functions/_lib/shopCustomers.ts:31:  const supabase = getSupabase(env)
functions/_lib/shopCustomers.ts:55:  const { error } = await supabase.from('ShopCustomers').upsert([record], { onConflict: 'shop,customer_id' })
functions/_lib/shopCustomers.ts:60:  const supabase = getSupabase(env)
functions/_lib/shopCustomers.ts:61:  const { error } = await supabase.from('ShopCustomers').delete().eq('shop', shop).eq('customer_id', id)
functions/_lib/shopCustomers.ts:66:  const supabase = getSupabase(env)
functions/_lib/shopCustomers.ts:68:    const { error } = await supabase.from('ShopCustomers').delete().eq('shop', shop).eq('customer_id', emailOrId.id)
functions/_lib/shopCustomers.ts:73:    const { error } = await supabase.from('ShopCustomers').delete().eq('shop', shop).eq('email', emailOrId.email.toLowerCase())
functions/_lib/customers.ts:2:import { getSupabase } from './supabase'
functions/_lib/customers.ts:5:  const supabase = getSupabase(env)
functions/_lib/customers.ts:28:  const { error } = await supabase.from('customers').upsert([record], { onConflict: 'id' })
api/admin/media/list-all.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/admin/media/list-all.ts:2:import { createClient } from '@supabase/supabase-js'
api/admin/media/list-all.ts:4:const { SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY } = process.env
api/admin/media/list-all.ts:6:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/admin/media/list-all.ts:7:  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
api/admin/media/list-all.ts:8:    return res.status(500).json({ error: 'Supabase service env missing' })
api/admin/media/list-all.ts:12:  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
api/admin/media/list-all.ts:13:  const { data, error } = await supabase
functions/_lib/shopifyOAuth.ts:6:  return /^(?:[a-z0-9][a-z0-9-]*)\\.myshopify\\.com$/i.test(shop)
functions/_lib/shopifyOAuth.ts:17:export async function verifyShopifyHmac(env: Env, url: URL) {
functions/_lib/shopifyOAuth.ts:18:  const secret = env.SHOPIFY_API_SECRET || ''
functions/_lib/shopifyOAuth.ts:19:  if (!secret) throw new Error('SHOPIFY_API_SECRET is not set')
functions/_lib/payments/stripe.ts:1:export const STRIPE_ALLOWED_SOURCES = new Set([
functions/_lib/payments/stripe.ts:7:export const coerceStripeSource = (raw: unknown): string => {
functions/_lib/payments/stripe.ts:9:  return STRIPE_ALLOWED_SOURCES.has(source) ? source : 'lumelle.account.payments.dev'
api/shopify/auth/callback.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/shopify/auth/callback.ts:4:import { ensureShopifySessionTable, getPgPool } from "../../_lib/db.js";
api/shopify/auth/callback.ts:6:function bad(res: VercelResponse, status = 400, msg = "Bad request") {
api/shopify/auth/callback.ts:10:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/shopify/auth/callback.ts:27:  if (!cookies["shopify_state"] || cookies["shopify_state"] !== state) return bad(res, 401, "Invalid state");
api/shopify/auth/callback.ts:31:  const expected = signHmac(message, process.env.SHOPIFY_API_SECRET || "");
api/shopify/auth/callback.ts:39:      client_id: process.env.SHOPIFY_API_KEY,
api/shopify/auth/callback.ts:40:      client_secret: process.env.SHOPIFY_API_SECRET,
api/shopify/auth/callback.ts:49:  await ensureShopifySessionTable()
api/shopify/auth/callback.ts:59:    await fetch(`https://${shop}/admin/api/${process.env.SHOPIFY_API_VERSION || '2025-10'}/graphql.json`, {
api/shopify/auth/callback.ts:63:        'X-Shopify-Access-Token': tokenJson.access_token,
api/shopify/auth/callback.ts:71:    await createWebhook('CUSTOMERS_CREATE', '/api/shopify/webhooks/customers-create');
api/shopify/auth/callback.ts:72:    await createWebhook('CUSTOMERS_UPDATE', '/api/shopify/webhooks/customers-update');
api/shopify/auth/callback.ts:73:    await createWebhook('CUSTOMERS_DELETE', '/api/shopify/webhooks/customers-delete');
api/shopify/auth/callback.ts:74:    await createWebhook('APP_UNINSTALLED', '/api/shopify/webhooks/app-uninstalled');
api/shopify/auth/callback.ts:75:    await createWebhook('ORDERS_CREATE', '/api/shopify/webhooks/orders-create');
api/shopify/auth/callback.ts:76:    await createWebhook('ORDERS_UPDATED', '/api/shopify/webhooks/orders-updated');
api/shopify/auth/callback.ts:77:    await createWebhook('FULFILLMENTS_CREATE', '/api/shopify/webhooks/fulfillments-create');
api/shopify/auth/callback.ts:84:    "shopify_state=; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=0",
api/shopify/auth/callback.ts:85:    "shopify_shop=; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=0",
api/shopify/auth/callback.ts:87:  res.setHeader('Location', `/shopify/app${hostPath}`)
api/admin/media/upsert.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/admin/media/upsert.ts:2:import { createClient } from '@supabase/supabase-js'
api/admin/media/upsert.ts:4:const { SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY } = process.env
api/admin/media/upsert.ts:6:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/admin/media/upsert.ts:7:  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
api/admin/media/upsert.ts:8:    return res.status(500).json({ error: 'Supabase service env missing' })
api/admin/media/upsert.ts:17:  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
api/admin/media/upsert.ts:18:  const { data, error } = await supabase
functions/_lib/webhooks.ts:2:import { getSupabase } from './supabase'
functions/_lib/webhooks.ts:6:  const supabase = getSupabase(env)
functions/_lib/webhooks.ts:7:  const { data, error } = await supabase.from('ShopWebhookDeliveries').select('id').eq('id', deliveryId).limit(1)
functions/_lib/webhooks.ts:14:  const supabase = getSupabase(env)
functions/_lib/webhooks.ts:15:  const { error } = await supabase.from('ShopWebhookDeliveries').upsert([{ id: deliveryId }], { onConflict: 'id' })
functions/checkouts/[[catchall]].ts:3:import { proxyShopifyCheckout } from '../_lib/shopifyCheckoutProxy'
functions/checkouts/[[catchall]].ts:5:export const onRequest: PagesFunction = (context) => proxyShopifyCheckout(context as any)
api/shopify/ping.ts:2:import { handlePing } from "../_lib/shopifyCore.js";
api/admin/sections/update.ts:1:import { getAdminToken, adminGraphQL } from "../../shopify/_admin.js";
api/admin/sections/update.ts:9:  const shop = url.searchParams.get('shop') || process.env.SHOPIFY_STORE_DOMAIN || ''
functions/api/storefront/landing/sections.ts:49:    schemaVersion: 'shopify.metaobjects.v1',
api/storefront/cart/restore.ts:16:  // TODO: fetch/create Shopify cart and replay lines/discounts/email
api/shopify/_admin.ts:1:import { ensureShopifySessionTable, getPgPool } from "../_lib/db.js";
api/shopify/_admin.ts:4:  await ensureShopifySessionTable()
api/shopify/_admin.ts:15:  const version = process.env.SHOPIFY_API_VERSION || "2025-10";
api/shopify/_admin.ts:20:      "X-Shopify-Access-Token": token,
api/cloudinary/sign.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/cloudinary/sign.ts:16:export default function handler(req: VercelRequest, res: VercelResponse) {
api/admin/sections/get.ts:1:import { getAdminToken, adminGraphQL } from "../../shopify/_admin.js";
api/admin/sections/get.ts:9:  const shop = url.searchParams.get('shop') || process.env.SHOPIFY_STORE_DOMAIN || ''
functions/api/payments/intent/create.ts:3:import { coerceStripeSource } from '../../../_lib/payments/stripe'
functions/api/payments/intent/create.ts:28:  if (!env.STRIPE_SECRET_KEY) {
functions/api/payments/intent/create.ts:30:    return json({ error: 'Stripe is not configured (missing STRIPE_SECRET_KEY).' }, { status: 500 })
functions/api/payments/intent/create.ts:58:  // Stable non-PII tag for Stripe Dashboard filtering.
functions/api/payments/intent/create.ts:59:  params.set('metadata[source]', coerceStripeSource(body?.source))
functions/api/payments/intent/create.ts:69:  // If a run id is provided by the client, keep it visible in Stripe Dashboard for correlation.
functions/api/payments/intent/create.ts:76:  const res = await fetch('https://api.stripe.com/v1/payment_intents', {
functions/api/payments/intent/create.ts:79:      authorization: `Bearer ${env.STRIPE_SECRET_KEY}`,
functions/api/payments/intent/create.ts:88:    return json({ error: raw || `Stripe ${res.status}` }, { status: 502 })
functions/api/payments/intent/create.ts:91:  const stripeJson = raw ? (JSON.parse(raw) as any) : null
functions/api/payments/intent/create.ts:92:  const clientSecret = stripeJson?.client_secret
functions/api/payments/intent/create.ts:94:    return json({ error: 'Stripe response missing client_secret.' }, { status: 502 })
api/storefront/_client.ts:1:const API_VERSION = process.env.SHOPIFY_API_VERSION || '2025-10'
api/storefront/_client.ts:2:const DOMAIN = process.env.SHOPIFY_STORE_DOMAIN
api/storefront/_client.ts:3:const PRIVATE_TOKEN = process.env.SHOPIFY_STOREFRONT_PRIVATE_TOKEN
api/storefront/_client.ts:15:      'X-Shopify-Storefront-Private-Token': PRIVATE_TOKEN as string,
api/og.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/og.ts:3:import { ImageResponse } from '@vercel/og'
api/og.ts:12:export default async function handler(req: VercelRequest, res: VercelResponse) {
functions/api/metrics/top-skus.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/top-skus.ts:12:  const supabase = getSupabase(env)
functions/api/metrics/top-skus.ts:13:  const { data, error } = await supabase.rpc('lumelle_metrics_top_skus', { days })
api/storefront/cart/share.ts:14:  // TODO: store snapshot or cartId ref in Supabase/R2 and use snapshotRef instead of inline snapshot.
functions/api/metrics/refund-rate.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/refund-rate.ts:12:  const supabase = getSupabase(env)
functions/api/metrics/refund-rate.ts:13:  const { data, error } = await supabase.rpc('lumelle_metrics_refund_rate', { days })
functions/api/metrics/refunds-by-sku.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/refunds-by-sku.ts:12:  const supabase = getSupabase(env)
functions/api/metrics/refunds-by-sku.ts:13:  const { data, error } = await supabase.rpc('lumelle_metrics_refunds_by_sku', { days })
functions/api/metrics/summary.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/summary.ts:7:  const supabase = getSupabase(env)
functions/api/metrics/summary.ts:8:  const { data, error } = await supabase.rpc('lumelle_metrics_summary')
src/ui/providers/DrawerProvider.tsx:151:        variantId: 'gid://shopify/ProductVariant/56829020504438',
src/ui/providers/DrawerProvider.tsx:159:        variantId: 'gid://shopify/ProductVariant/56852779696502',
functions/api/metrics/repeat.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/repeat.ts:7:  const supabase = getSupabase(env)
functions/api/metrics/repeat.ts:8:  const { data, error } = await supabase.rpc('lumelle_metrics_repeat')
functions/api/metrics/utm-sources.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/utm-sources.ts:12:  const supabase = getSupabase(env)
functions/api/metrics/utm-sources.ts:13:  const { data, error } = await supabase.rpc('lumelle_metrics_utm_sources', { days })
functions/api/metrics/daily.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/daily.ts:12:  const supabase = getSupabase(env)
functions/api/metrics/daily.ts:13:  const { data, error } = await supabase.rpc('lumelle_metrics_daily', { days })
functions/api/metrics/source-revenue.ts:2:import { getSupabase } from '../../_lib/supabase'
functions/api/metrics/source-revenue.ts:12:  const supabase = getSupabase(env)
functions/api/metrics/source-revenue.ts:13:  const { data, error } = await supabase.rpc('lumelle_metrics_source_revenue', { days })
api/customer-auth/callback.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/customer-auth/callback.ts:3:function getCookie(req: VercelRequest, name: string) {
api/customer-auth/callback.ts:17:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/customer-auth/logout.ts:1:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/customer-auth/logout.ts:3:export default function handler(_req: VercelRequest, res: VercelResponse) {
src/domains/client/account/index.ts:8:export * from './hooks/useSyncUserToSupabase'
src/types/shopify-window.d.ts:3:    shopify: any;
api/customer-auth/start.ts:3:import type { VercelRequest, VercelResponse } from '@vercel/node'
api/customer-auth/start.ts:5:export default async function handler(req: VercelRequest, res: VercelResponse) {
api/customer-auth/start.ts:8:  const shop = (url.searchParams.get('shop') || process.env.SHOPIFY_STORE_DOMAIN || '').trim()
src/domains/client/account/hooks/useSyncUserToSupabase.ts:3:import { createSupabaseClient, supabase } from '@platform/storage/supabase'
src/domains/client/account/hooks/useSyncUserToSupabase.ts:20:export const useSyncUserToSupabase = () => {
src/domains/client/account/hooks/useSyncUserToSupabase.ts:47:      const token = await getToken({ template: 'supabase' }).catch(() => null)
src/domains/client/account/hooks/useSyncUserToSupabase.ts:48:      const client = token ? createSupabaseClient(token) : supabase
src/domains/client/account/hooks/useSyncUserToSupabase.ts:52:        console.error('Failed to sync Clerk user to Supabase', error)
api/customer-auth/utils.ts:3:  const ca = await fetch(`https://${shop}/.well-known/shopify/customer-account-api/unstable`).then(r => r.json())
src/domains/client/shop/cart/logic/volumeDiscounts.ts:9:export const SHOWER_CAP_VARIANT_ID = 'gid://shopify/ProductVariant/56829020504438'
src/domains/client/shop/cart/logic/volumeDiscounts.ts:13:// Public discount codes (configured in Shopify admin).
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:10:import { StripeDevEmbeddedPaymentPanel } from '@client/account/ui/components/StripeDevEmbeddedPaymentPanel'
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:18:  const stripePublishableKey = env('STRIPE_PUBLISHABLE_KEY')
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:19:  const stripeDashboardBase = (() => {
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:20:    const key = (stripePublishableKey ?? '').trim()
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:21:    if (!key) return 'https://dashboard.stripe.com'
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:22:    return key.startsWith('pk_test_') ? 'https://dashboard.stripe.com/test' : 'https://dashboard.stripe.com'
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:24:  const stripeModeLabel = stripeDashboardBase.includes('/test') ? 'test' : 'live'
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:25:  const stripeKeyPrefix = (() => {
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:26:    const key = (stripePublishableKey ?? '').trim()
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:53:      const raw = localStorage.getItem('lumelle_dev_last_stripe_debug_ts')
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:63:      const raw = localStorage.getItem('lumelle_dev_last_stripe_run_id')
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:77:      const stripeStatus = params.get('redirect_status')
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:78:      if (stripeStatus === 'succeeded') return { kind: 'success' as const, message: 'Payment succeeded.' }
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:79:      if (stripeStatus === 'failed') return { kind: 'error' as const, message: 'Payment failed.' }
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:80:      if (stripeStatus === 'canceled') return { kind: 'warning' as const, message: 'Payment was cancelled.' }
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:88:  const stripeDebug = (() => {
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:108:  const effectivePaymentIntent = stripeDebug?.paymentIntent ?? lastIntent
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:110:    const s = (stripeDebug?.redirectStatus ?? lastRedirectStatus ?? '').trim().toLowerCase()
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:132:      localStorage.setItem('lumelle_dev_last_stripe_debug_ts', String(ts))
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:135:      localStorage.setItem('lumelle_dev_last_stripe_run_id', runId)
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:165:  const openStripeDashboardSearch = (query: string) => {
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:167:      const url = `${stripeDashboardBase}/search?query=${encodeURIComponent(query)}`
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:208:                {stripeDebug ? (
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:212:                        Stripe {stripeModeLabel}
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:215:                        {stripeKeyPrefix}
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:220:                      <span className="font-mono text-[11px]">{stripeDashboardBase}</span>
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:266:                            onClick={() => openStripeDashboardSearch(effectivePaymentIntent!)}
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:269:                            Open in Stripe
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:276:                      <span className="font-mono text-[11px]">{stripeDebug.redirectStatus ?? '(none)'}</span>
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:278:                    {lastRedirectStatus && !stripeDebug.redirectStatus ? (
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:286:                      <span className="font-mono text-[11px]">{stripeDebug.clientSecretSuffix ?? '(none)'}</span>
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:301:                            localStorage.removeItem('lumelle_dev_last_stripe_debug_ts')
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:302:                            localStorage.removeItem('lumelle_dev_last_stripe_run_id')
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:351:                  disabled={!canTest || !stripePublishableKey}
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:359:                {!stripePublishableKey ? (
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:362:                    Missing <span className="font-mono text-[12px]">VITE_STRIPE_PUBLISHABLE_KEY</span>.
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:369:            {import.meta.env.DEV && clientSecret && stripePublishableKey ? (
src/domains/client/account/ui/pages/PaymentMethodsPage.tsx:370:              <StripeDevEmbeddedPaymentPanel publishableKey={stripePublishableKey} clientSecret={clientSecret} />
src/domains/client/shop/cart/providers/CartContext.tsx:93:const isLegacyShopifyGid = (id: string) => id.startsWith('gid://shopify/')
src/domains/client/shop/cart/providers/CartContext.tsx:95:const clearLegacyShopifyCartId = () => {
src/domains/client/shop/cart/providers/CartContext.tsx:97:    localStorage.removeItem('lumelle_shopify_cart_id')
src/domains/client/shop/cart/providers/CartContext.tsx:252:    clearLegacyShopifyCartId()
src/domains/client/shop/cart/providers/CartContext.tsx:255:      // Filter out legacy Shopify GIDs (pre-ports) to avoid feeding undecodable IDs into ports.
src/domains/client/shop/cart/providers/CartContext.tsx:257:      const compatibleSeed = seedItems.filter((i) => !isLegacyShopifyGid(i.id))
src/domains/client/account/state/OrdersStore.ts:1:import { createSupabaseClient, supabase } from '@platform/storage/supabase'
src/domains/client/account/state/OrdersStore.ts:23:  if (authToken) return createSupabaseClient(authToken)
src/domains/client/account/state/OrdersStore.ts:24:  return supabase
src/domains/client/account/state/OrdersStore.ts:59:    console.error('Supabase fetchOrders failed; falling back to cache', error)
src/domains/client/account/state/OrdersStore.ts:80:    console.error(`Supabase fetchOrderById failed for ${id}; using cache`, error)
src/domains/client/account/state/OrdersStore.ts:99:    console.error('Supabase addOrder failed; order is only saved locally', error)
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:11:  const shopifyStoreDomain = env('SHOPIFY_STORE_DOMAIN')
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:24:  const shopifyCheckoutUrl = useMemo(() => {
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:25:    const raw = (shopifyStoreDomain ?? '').trim()
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:34:  }, [fullPath, shopifyStoreDomain])
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:60:            {shopifyCheckoutUrl ? (
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:62:                href={shopifyCheckoutUrl}
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:83:                  Shopify’s Storefront API returns cart checkout URLs on the shop’s <em>primary domain</em>. If Shopify’s primary domain is set to this same host
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:84:                  while the headless app is deployed here, checkout URLs resolve back into the SPA instead of Shopify.
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:94:                      Configured Shopify API domain:{' '}
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:95:                      <span className="font-mono text-[12px]">{shopifyStoreDomain ?? '(not set)'}</span>
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:104:                      In Shopify Admin → <span className="font-medium">Settings → Domains</span>, change the <span className="font-medium">primary domain</span> to a
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:105:                      Shopify-served domain (recommended: a subdomain like <span className="font-mono text-[12px]">shop.yourdomain.com</span>), and point that
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:106:                      subdomain’s DNS to Shopify.
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:109:                      If you must keep Shopify’s primary domain as-is, proxy Shopify checkout routes (at minimum <span className="font-mono text-[12px]">/cart/c/*</span>{' '}
src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx:110:                      and likely <span className="font-mono text-[12px]">/checkouts/*</span>) to Shopify at the edge (Cloudflare/Workers).
src/domains/admin/shared/logic/clerkJwt.ts:1:export type ClerkSupabaseJwtPayload = {
src/domains/admin/shared/logic/clerkJwt.ts:7:export function decodeClerkJwtPayload(token: string): ClerkSupabaseJwtPayload | null {
src/domains/admin/shared/logic/clerkJwt.ts:14:    return JSON.parse(json) as ClerkSupabaseJwtPayload
src/domains/admin/catalog/data/useProducts.ts:2:import { createSupabaseClient, isSupabaseConfigured } from '@/lib/supabase'
src/domains/admin/catalog/data/useProducts.ts:33:    if (!isSupabaseConfigured || !token) {
src/domains/admin/catalog/data/useProducts.ts:42:    const client = createSupabaseClient(token)
src/domains/admin/catalog/data/useProducts.ts:44:      setError('Supabase is not configured in this environment (missing VITE_SUPABASE_URL / VITE_SUPABASE_ANON_KEY).')
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:7:import { createSupabaseClient, isSupabaseConfigured } from '@/lib/supabase'
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1002:      const token = await getToken({ template: 'supabase' }).catch(() => null)
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1004:        setError('Missing Clerk JWT template `supabase` token. Check Clerk → JWT Templates.')
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1011:      const client = createSupabaseClient(token)
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1013:        setError('Supabase is not configured in this environment (missing VITE_SUPABASE_URL / VITE_SUPABASE_ANON_KEY).')
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1169:      // Fallback to in-repo product config when Supabase has no rows yet (common on fresh envs)
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1349:  // Send draft to iframe preview for live render (preview page does not read Supabase yet).
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1368:          'This environment is in config-fallback mode (no `cms_products` rows found). Saving is disabled until products are seeded in Supabase.',
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1372:      const token = await getToken({ template: 'supabase' }).catch(() => null)
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1374:        setError('Missing Clerk JWT template `supabase` token.')
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1377:      const client = createSupabaseClient(token)
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1379:        setError('Supabase is not configured in this environment.')
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1547:      {!isSupabaseConfigured ? (
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1549:          Supabase is not configured for the frontend (missing <span className="font-mono text-[12px]">VITE_SUPABASE_URL</span> /{' '}
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1550:          <span className="font-mono text-[12px]">VITE_SUPABASE_ANON_KEY</span>).
src/domains/admin/catalog/ui/pages/ProductsPage.tsx:1556:          <span className="font-mono text-[12px]">cms_products</span> rows in Supabase for this environment. Saving is disabled until the
src/domains/admin/pages/data/pages.ts:150:      { title: 'Vendors', body: 'Shopify, Supabase, Clerk, PostHog — DPIAs on file.' },
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:2:import { loadStripe } from '@stripe/stripe-js'
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:3:import { Elements, PaymentElement, useElements, useStripe } from '@stripe/react-stripe-js'
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:4:import type { StripeElementsOptions } from '@stripe/stripe-js'
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:7:  const stripe = useStripe()
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:13:    if (!stripe || !elements || submitting) return
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:17:      const result = await stripe.confirmPayment({
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:43:        disabled={!stripe || !elements || submitting}
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:51:        Dev-only: this uses Stripe Elements. Do not expose this flow in production until you have the full UX and confirmation handling.
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:57:export const StripeDevEmbeddedPaymentPanel = ({
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:64:  const stripePromise = useMemo(() => loadStripe(publishableKey), [publishableKey])
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:66:  const options: StripeElementsOptions = useMemo(
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:69:      appearance: { theme: 'stripe' },
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:78:        Stripe client secret created. Complete the form below to confirm the payment.
src/domains/client/account/ui/components/StripeDevEmbeddedPaymentPanel.tsx:80:      <Elements stripe={stripePromise} options={options}>
src/domains/admin/pages/ui/pages/PagesPage.tsx:156:      { title: 'Vendors', body: 'Shopify, Supabase, Clerk, PostHog — DPIAs on file.' },
src/domains/admin/pages/ui/pages/ContentPage.tsx:74:    <AdminPageLayout title="Product content" subtitle="Edit landing/PDP copy blocks (Shopify metafield-backed).">
src/domains/admin/pages/ui/pages/ContentPage.tsx:98:            If you’re running the Vite dev server (`npm run dev`), the `/api/...` routes might not be executing (they’re Vercel functions).
src/domains/admin/pages/ui/pages/ContentPage.tsx:99:            Use `vercel dev` for full-stack local API support, or wire a proxy/middleware.
src/domains/client/shop/products/data/product-loaders.ts:42:  // Sections are currently stored as global Shopify metaobjects (hero/faq/how/etc).
src/domains/admin/blog/ui/pages/BlogsPage.tsx:250:      subtitle="Blog posts and metrics live in Supabase (cms_blogs + cms_blog_media)."
src/domains/admin/blog/ui/pages/BlogsPage.tsx:606:        Next steps: hook this list to Supabase (cms_blogs), wire filters, and add blog detail page with live preview.
src/domains/client/shop/products/data/product-config.ts:187:  fallbackVariantId: 'gid://shopify/ProductVariant/56852779696502',
src/domains/client/shop/products/data/product-config.ts:229:    fallbackVariantId: 'gid://shopify/ProductVariant/56829020504438',
src/domains/admin/catalog/ui/cards/ProductCard.tsx:9:  // Used for admin clarity when legacy/alias handles still exist in Supabase.
src/domains/admin/orders/ui/pages/OrdersPage.tsx:179:      subtitle="Prototype UI. Next: wire to Shopify (or Supabase mirror), then add search + actions."
src/domains/admin/orders/ui/pages/OrdersPage.tsx:187:            {ordersSource === 'api' ? 'Supabase mirror' : 'Mock data'}
src/domains/admin/orders/ui/pages/OrdersPage.tsx:335:                  Actions (open in Shopify, refund, resend confirmation)
src/domains/admin/settings/ui/pages/SettingsPage.tsx:19:            Integrations (Shopify, Supabase, email, analytics)
src/domains/platform/content/adapters/shopify/internal-api/sections.ts:4:export const createShopifyLandingSectionsPort = (): ContentPort => {
src/domains/platform/content/adapters/shopify/internal-api/index.ts:2:import { createShopifyLandingSectionsPort } from './sections'
src/domains/platform/content/adapters/shopify/internal-api/index.ts:4:export type ShopifyContentAdapter = {
src/domains/platform/content/adapters/shopify/internal-api/index.ts:8:export const createShopifyContentAdapter = (): ShopifyContentAdapter => {
src/domains/platform/content/adapters/shopify/internal-api/index.ts:9:  return { sections: createShopifyLandingSectionsPort() }
src/domains/platform/content/runtime.ts:4:import { createShopifyContentAdapter } from './adapters/shopify/internal-api'
src/domains/platform/content/runtime.ts:12:const isShopifyConfigured = () => {
src/domains/platform/content/runtime.ts:13:  const domain = env('SHOPIFY_STORE_DOMAIN')
src/domains/platform/content/runtime.ts:48:  const configured = isShopifyConfigured()
src/domains/platform/content/runtime.ts:54:      'Content provider is not configured (missing SHOPIFY_STORE_DOMAIN).'
src/domains/platform/content/runtime.ts:61:  const adapter = createShopifyContentAdapter()
src/domains/platform/storage/supabase.ts:1:import { createClient } from '@supabase/supabase-js'
src/domains/platform/storage/supabase.ts:2:import type { SupabaseClient } from '@supabase/supabase-js'
src/domains/platform/storage/supabase.ts:4:const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
src/domains/platform/storage/supabase.ts:5:const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY
src/domains/platform/storage/supabase.ts:7:const clientCache = new Map<string, SupabaseClient>()
src/domains/platform/storage/supabase.ts:9:const buildClient = (authToken?: string): SupabaseClient =>
src/domains/platform/storage/supabase.ts:10:  createClient(supabaseUrl!, supabaseAnonKey!, {
src/domains/platform/storage/supabase.ts:25:export const createSupabaseClient = (authToken?: string) => {
src/domains/platform/storage/supabase.ts:26:  if (!supabaseUrl || !supabaseAnonKey) return null
src/domains/platform/storage/supabase.ts:36:export const supabase = createSupabaseClient()
src/domains/platform/storage/supabase.ts:38:export const isSupabaseConfigured = Boolean(supabase)
src/domains/client/marketing/ui/sections/shop/final-cta-section/SpinWheelLocal.tsx:4:import { createSupabaseClient } from '@/lib/supabase'
src/domains/client/marketing/ui/sections/shop/final-cta-section/SpinWheelLocal.tsx:81:    const token = await getToken({ template: 'supabase' }).catch(() => null)
src/domains/client/marketing/ui/sections/shop/final-cta-section/SpinWheelLocal.tsx:82:    const client = token ? createSupabaseClient(token) : null
src/domains/client/marketing/ui/sections/shop/final-cta-section/SpinWheelLocal.tsx:97:    const token = await getToken({ template: 'supabase' }).catch(() => null)
src/domains/client/marketing/ui/sections/shop/final-cta-section/SpinWheelLocal.tsx:98:    const client = token ? createSupabaseClient(token) : null
src/domains/client/marketing/ui/sections/shop/final-cta-section/SpinWheelLocal.tsx:99:    if (!client) throw new Error('Supabase not configured')
src/domains/platform/commerce/adapters/shopify/internal-api/catalog.ts:5:type ShopifyMoney = { amount: string; currencyCode: string }
src/domains/platform/commerce/adapters/shopify/internal-api/catalog.ts:6:type ShopifyProduct = {
src/domains/platform/commerce/adapters/shopify/internal-api/catalog.ts:12:  variants?: { edges?: Array<{ node?: { id: string; title?: string | null; price?: ShopifyMoney } | null } | null> | null } | null
src/domains/platform/commerce/adapters/shopify/internal-api/catalog.ts:15:export const createShopifyCatalogPort = (): CatalogPort => {
src/domains/platform/commerce/adapters/shopify/internal-api/catalog.ts:18:      const data = await requestJson<{ product: ShopifyProduct | null }>(`/api/storefront/product/by-handle?handle=${encodeURIComponent(handle)}`)
src/domains/platform/payments/adapters/stripe/index.ts:5:export type StripePaymentsAdapter = {
src/domains/platform/payments/adapters/stripe/index.ts:9:export const createStripePaymentsAdapter = (): StripePaymentsAdapter => {
src/domains/platform/payments/adapters/stripe/index.ts:14:        providerLabel: 'Payments (Stripe)',
src/domains/platform/payments/adapters/stripe/index.ts:31:        throw new PortError('UNAVAILABLE', 'Stripe payments request failed.', { cause: err })
src/domains/platform/commerce/adapters/shopify/internal-api/checkout.ts:4:import { __internalShopifyCartKeyStorage } from './cart'
src/domains/platform/commerce/adapters/shopify/internal-api/checkout.ts:6:type ShopifyCart = {
src/domains/platform/commerce/adapters/shopify/internal-api/checkout.ts:20:export const createShopifyCheckoutPort = (): CheckoutPort => {
src/domains/platform/commerce/adapters/shopify/internal-api/checkout.ts:33:      const stored = __internalShopifyCartKeyStorage.getStoredCartKey()
src/domains/platform/commerce/adapters/shopify/internal-api/checkout.ts:37:      const data = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/fetch?id=${encodeURIComponent(rawCartId)}`)
src/domains/platform/payments/runtime.ts:4:import { createStripePaymentsAdapter } from './adapters/stripe'
src/domains/platform/payments/runtime.ts:12:type PaymentsProvider = 'none' | 'stripe'
src/domains/platform/payments/runtime.ts:16:  if (v === 'stripe') return 'stripe'
src/domains/platform/payments/runtime.ts:56:  if (provider === 'stripe') {
src/domains/platform/payments/runtime.ts:57:    const adapter = createStripePaymentsAdapter()
src/domains/platform/commerce/runtime.ts:4:import { createShopifyCommerceAdapter } from './adapters/shopify/internal-api'
src/domains/platform/commerce/runtime.ts:14:const isShopifyConfigured = () => {
src/domains/platform/commerce/runtime.ts:15:  const domain = env('SHOPIFY_STORE_DOMAIN')
src/domains/platform/commerce/runtime.ts:126:  const configured = isShopifyConfigured()
src/domains/platform/commerce/runtime.ts:132:      'Commerce provider is not configured (missing SHOPIFY_STORE_DOMAIN).'
src/domains/platform/commerce/runtime.ts:139:  const adapter = createShopifyCommerceAdapter()
src/domains/platform/commerce/adapters/shopify/internal-api/keys.ts:1:// Opaque key encoding to avoid leaking raw Shopify GIDs above the adapter boundary.
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:6:type ShopifyCartLine = {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:18:type ShopifyCart = {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:21:  lines?: { edges?: Array<{ node: ShopifyCartLine }> } | null
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:42:const mapCart = (cart: ShopifyCart): CartDTO => {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:74:export const createShopifyCartPort = (): CartPort => {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:79:    const created = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/create`, { method: 'POST', body: {} })
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:85:  const fetchCart = async (rawCartId: string): Promise<ShopifyCart> => {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:86:    const data = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/fetch?id=${encodeURIComponent(rawCartId)}`)
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:90:  const updateStoredKey = (cart: ShopifyCart) => setStoredCartKey(encodeCartKey(cart.id))
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:104:      const created = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/create`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:111:        const next = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/add-lines`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:119:        const next = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/discount-codes-update`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:128:        const next = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/attributes-update`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:136:        const next = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/set-buyer-identity`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:150:        const created = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/create`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:159:      const updated = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/add-lines`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:171:      const updated = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/update-line`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:183:      const updated = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/remove-lines`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:193:      const updated = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/discount-codes-update`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:203:      const updated = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/set-buyer-identity`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:214:      const updated = await requestJson<{ cart: ShopifyCart }>(`/api/storefront/cart/attributes-update`, {
src/domains/platform/commerce/adapters/shopify/internal-api/cart.ts:224:export const __internalShopifyCartKeyStorage = {
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:2:import { createShopifyCatalogPort } from './catalog'
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:3:import { createShopifyCartPort } from './cart'
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:4:import { createShopifyCheckoutPort } from './checkout'
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:6:export type ShopifyCommerceAdapter = {
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:12:export const createShopifyCommerceAdapter = (): ShopifyCommerceAdapter => {
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:13:  const cart = createShopifyCartPort()
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:14:  const checkout = createShopifyCheckoutPort()
src/domains/platform/commerce/adapters/shopify/internal-api/index.ts:15:  const catalog = createShopifyCatalogPort()
