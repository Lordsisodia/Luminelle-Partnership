# source: functions/api/storefront/cart/attributes-update.ts
# captured: 2025-12-31T14:58:18Z

import type { PagesFunction } from '../../../_lib/types'
import { CART_FRAGMENT, runStorefront } from '../../../_lib/storefront'
import { json, methodNotAllowed, text } from '../../../_lib/response'

export const onRequest: PagesFunction = async ({ request, env }) => {
  if (request.method !== 'POST') return methodNotAllowed(['POST'])
  const body = await request.json().catch(() => ({} as any))
  if (!body.cartId || !Array.isArray(body.attributes)) return text('Missing params', { status: 400 })

  const data = await runStorefront<any>(
    env,
    `#graphql
      mutation CartAttributesUpdate($cartId:ID!, $attributes:[AttributeInput!]!) {
        cartAttributesUpdate(cartId:$cartId, attributes:$attributes) { cart { ...CartFields } }
      }
      ${CART_FRAGMENT}
    `,
    { cartId: body.cartId, attributes: body.attributes },
  )
  return json({ cart: data.cartAttributesUpdate.cart })
}

