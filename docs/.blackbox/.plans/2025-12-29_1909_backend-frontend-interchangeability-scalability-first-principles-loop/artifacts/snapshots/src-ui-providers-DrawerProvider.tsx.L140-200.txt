    ? useMemo(() => {
        const raw = user?.publicMetadata?.loyaltyPoints
        return typeof raw === 'number' ? raw : 0
      }, [user?.publicMetadata?.loyaltyPoints])
    : 0
  const nextTier = 500
  const loyaltyProgress = SHOW_LOYALTY ? Math.min(100, Math.round((loyaltyPoints / nextTier) * 100)) : 0

  const upsellProducts = useMemo(
    () => [
      {
        variantKey: 'variant.lumelle-shower-cap.default',
        id: 'shower-cap',
        title: 'Lumelle Shower Cap',
        price: 14.99,
        image: '/uploads/luminele/product-feature-05.webp',
        href: '/product/lumelle-shower-cap',
      },
      {
        variantKey: 'variant.satin-overnight-curler.default',
        id: 'heatless-curler',
        title: 'Satin Overnight Curler Set',
        price: 16.99,
        image: '/uploads/curler/3.webp',
        href: '/product/satin-overnight-curler',
      },
    ],
    []
  )
  const cartIds = useMemo(() => new Set(items.map((i) => i.id)), [items])
  const filteredUpsells = useMemo(() => {
    return upsellProducts.filter((p) => !cartIds.has(p.variantKey))
  }, [upsellProducts, cartIds])

  const renderUpsellCard = useCallback(
    (p: typeof upsellProducts[number]) => {
      return (
        <div
          key={p.id}
          className="relative flex items-center gap-3 rounded-xl border border-semantic-legacy-brand-blush/60 bg-white p-3 shadow-soft"
        >
          <img
            src={p.image}
            alt={p.title}
            className="h-14 w-14 rounded-lg border border-semantic-legacy-brand-blush/60 object-cover"
            loading="lazy"
            decoding="async"
          />
          <div className="flex-1 text-left pr-16">
            <div className="text-sm font-semibold text-semantic-text-primary leading-tight">{p.title}</div>
            <div className="mt-1 text-xs font-semibold text-semantic-text-primary">Â£{p.price.toFixed(2)}</div>
          </div>
          <button
            onClick={() => add({ id: p.variantKey, title: p.title, price: p.price, image: p.image }, 1)}
            className="absolute right-3 top-1/2 -translate-y-1/2 transform rounded-full border border-semantic-legacy-brand-cocoa px-3 py-1 text-xs font-semibold text-semantic-legacy-brand-cocoa hover:bg-semantic-legacy-brand-blush/30"
          >
            Add
          </button>
        </div>
      )
    },
