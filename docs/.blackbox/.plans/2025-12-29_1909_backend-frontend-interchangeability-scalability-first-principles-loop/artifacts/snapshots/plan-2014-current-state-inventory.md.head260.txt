# source: .blackbox/.plans/2025-12-28_2014_deep-research-architecture-ui-infra-plug-in-ports-adapters/artifacts/current-state-inventory.md
# captured: 2025-12-30T10:30:35Z

# Current State Inventory (UI ↔ Infra plug-in)

This is a fast “starting point” for the agent cycle prompts 6–7:
- **already ported** (good boundaries exist)
- **still leaking** (vendor IDs/copy/assumptions in UI or shared libs)

Accessed: 2025-12-29

## Already ported (good)

Commerce runtime + contracts:
- `src/domains/platform/commerce/runtime.ts` — central provider selection (`mock` vs `shopify`)
- `src/domains/platform/commerce/ports/cart.ts` — `CartPort` + DTOs (`CartDTO`, `CartLineDTO`, keys)
- `src/domains/platform/commerce/ports/catalog.ts` — `CatalogPort` + DTOs
- `src/domains/platform/commerce/ports/checkout.ts` — `CheckoutPort` + capabilities model
- `src/domains/platform/commerce/adapters/shopify/internal-api/*` — Shopify implementation hidden behind internal API

Client cart is mostly port-driven:
- `src/domains/client/shop/cart/providers/CartContext.tsx`
  - Uses `commerce` (`@platform/commerce`) and port DTOs
  - Contains migration logic for **legacy Shopify GIDs** and legacy storage keys (expected transitional code)

Payments already demonstrate “Stripe later” reality:
- `src/domains/platform/payments/runtime.ts` — provider selection (`none` vs `stripe`, mock vs real)
- `src/domains/platform/payments/adapters/stripe/index.ts` — `PaymentsPort` implementation

## Still leaking (fix candidates)

Vendor IDs in UI/provider:
- `src/ui/providers/DrawerProvider.tsx`
  - Contains `gid://shopify/ProductVariant/...` values inside UI/provider code

Vendor IDs in client domain config/logic:
- `src/domains/client/shop/cart/logic/volumeDiscounts.ts`
  - Constants like `SHOWER_CAP_VARIANT_ID = 'gid://shopify/ProductVariant/...'`
- `src/domains/client/shop/products/data/product-config.ts`
  - `fallbackVariantId: 'gid://shopify/ProductVariant/...'` in product config

Handoff UX risk area (vendor routing/copy creep):
- `src/domains/client/shop/cart/ui/pages/CheckoutHandoffPage.tsx`
  - Domain/DNS and route guidance can easily become Shopify-specific; prefer `CheckoutPort.getCapabilities()`-driven copy

Legacy “shared lib” audit targets (verify no vendor APIs leak through):
- `src/lib/product.ts`
- `src/lib/sections.ts`

## Quick hypothesis (for ranking)

Highest leverage fixes (low scope, high clarity):
1) Move all `gid://shopify/...` out of UI and into platform adapter resolution (or config keys that map to vendor IDs at the edge).
2) Standardize on `VariantKey`/`ProductKey` everywhere UI touches commerce.
3) Keep `CheckoutHandoffPage` generic; treat vendor routing as a capability (already present in commerce runtime).

