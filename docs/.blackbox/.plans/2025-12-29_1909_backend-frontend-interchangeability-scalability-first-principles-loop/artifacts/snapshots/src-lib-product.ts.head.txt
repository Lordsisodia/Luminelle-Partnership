# source: src/lib/product.ts
# captured: 2025-12-29T12:54:31Z

import { env } from '@/utils/env'
import { commerce } from '@platform/commerce'
import { PortError } from '@platform/ports'

const FALLBACK_IMAGE = '/uploads/luminele/product-main.webp'

export type Product = {
  id: string
  title: string
  description: string
  price: { amount: number; currencyCode?: string }
  images: string[]
  variantId: string
}

const isDev = () => import.meta.env.DEV
const shouldUseRealCommerceInDev = () => env('USE_REAL_COMMERCE') === 'true'

export const fetchProduct = async (id: string): Promise<Product> => {
  // Legacy placeholder; replaced when Shopify is configured and callers use `fetchProductByHandle`.
  return {
    id,
    title: 'Stub product',
    description: 'Placeholder description',
    price: { amount: 0, currencyCode: 'GBP' },
    images: [FALLBACK_IMAGE],
    variantId: id,
  }
}

export const fetchProductByHandle = async (handle: string): Promise<Product> => {
  // Keep legacy behavior: in dev we don't want mock commerce results to overwrite hard-coded defaults
  // unless we explicitly opt into the real adapter.
  if (isDev() && !shouldUseRealCommerceInDev()) return fetchProduct(handle)

  try {
    const dto = await commerce.catalog.getProductByHandle(handle)

    const defaultVariant =
      (dto.defaultVariantKey && dto.variants.find((v) => v.variantKey === dto.defaultVariantKey)) || dto.variants[0]
    if (!defaultVariant) return fetchProduct(handle)

    const mergedImages = dto.images.length ? dto.images : [FALLBACK_IMAGE]

    return {
      id: dto.productKey,
      title: dto.title,
      description: dto.description ?? '',
      price: {
        amount: defaultVariant.unitPrice.amount,
        currencyCode: defaultVariant.unitPrice.currencyCode,
      },
      images: mergedImages,
      variantId: defaultVariant.variantKey,
    }
  } catch (error) {
    // Prefer "no override" behavior for optional product enrichment rather than breaking the page.
    if (error instanceof PortError) return fetchProduct(handle)
    return fetchProduct(handle)
  }
}
