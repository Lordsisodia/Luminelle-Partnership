# source: src/domains/platform/http/internal-api/client.ts
# captured: 2025-12-29T12:53:01Z

import { PortError } from '@platform/ports'

type JsonRequestInit = Omit<RequestInit, 'body'> & { body?: unknown }

const classifyError = (status: number, message: string) => {
  const msg = message.toLowerCase()
  if (status === 400) return { code: 'INVALID_INPUT' as const }
  if (status === 404) return { code: 'NOT_FOUND' as const }
  if (status === 429) return { code: 'RATE_LIMITED' as const }
  if (status >= 500) {
    if (msg.includes('missing') || msg.includes('not configured') || msg.includes('not set')) {
      return { code: 'NOT_CONFIGURED' as const }
    }
    return { code: 'UNAVAILABLE' as const }
  }
  return { code: 'UNKNOWN' as const }
}

export const requestJson = async <T>(path: string, init?: JsonRequestInit): Promise<T> => {
  const res = await fetch(path, {
    ...init,
    headers: { 'content-type': 'application/json', ...(init?.headers ?? {}) },
    body: init?.body === undefined ? undefined : JSON.stringify(init.body),
  })

  if (!res.ok) {
    const raw = await res.text().catch(() => '')
    const message = raw || `HTTP ${res.status} (${res.statusText})`
    const { code } = classifyError(res.status, message)
    throw new PortError(code, message, { details: { path, status: res.status } })
  }

  return (await res.json()) as T
}

