# Prompt 4 — Scalability Plan (edge/UI + backend/data)

This is a docs-only plan for scaling:
1) **Frontend / edge delivery** (Cloudflare + UI)
2) **Backend boundary** (BFF/API + provider adapters)
3) **Data layer** (Supabase, tenancy readiness, isolation)

All “current state” claims cite either:
- a code file path, or
- a saved command output under `artifacts/snapshots/`

Key evidence snapshots for current state:
- Boot + composition:  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-main.tsx.head.txt`  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-router.tsx.head.txt`  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-App.tsx.head.txt`
- Platform boundary inventories:  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/platform-ports-files.txt`  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/platform-runtime-files.txt`
- Coupling evidence (vendor mentions):  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/coupling-shopify-gid-matches.txt`  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/coupling-shopify-word-matches.txt`  
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/coupling-supabase-matches.txt`
  - Vendor SDK imports outside platform domains (report-only coupling signal):  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/boundary-vendor-sdk-imports.nonplatform.rg.txt`

---

## 0) First principles: what “scaling” means here

Scaling is not only “handle more traffic”; it’s:
- keep p95 latency predictable under load
- keep costs predictable (Cloudflare/Supabase/Shopify/Stripe)
- avoid cascading failures (rate limits, DB spikes)
- keep architecture maintainable while adding tenants and swapping UIs

This plan assumes:
- Cloudflare serves the frontend and hosts the backend boundary (`/api/*`).
- Shopify remains commerce provider today.
- Supabase remains the database.

---

## 1) Frontend + Edge delivery scalability (Cloudflare + UI)

### 1.1 Keep the global provider tree minimal and stable

Current state evidence:
- The router-level provider tree wraps the entire app in Cart/Auth/Drawer providers.  
  Evidence: `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-router.tsx.head.txt`

Plan:
- Treat everything in the root provider tree as “tax paid by every route”.
- Move expensive/rare concerns out of the global tree (into route-level providers) when feasible.

Acceptance checks:
- The number of always-on providers does not grow without justification (tracked in `src/router.tsx`).  
  Evidence anchor: `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-router.tsx.head.txt`

### 1.2 Maintain route-level code splitting

Current state evidence:
- `src/App.tsx` uses `lazy()` + `Suspense` for route splitting.  
  Evidence: `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-App.tsx.head.txt`

Plan:
- Keep routes as the primary splitting boundary (do not regress into monolithic bundles).
- Isolate “admin” and “dev tools” UI so storefront bundles remain small.

Acceptance checks:
- `src/App.tsx` continues to lazy-load major pages (storefront, admin, account).  
  Evidence anchor: `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-App.tsx.head.txt`

### 1.3 Edge caching strategy (public, anonymous content)

Principle:
- Public, read-mostly content should be cached at the edge aggressively, with explicit invalidation rules.

Targets:
- Landing sections / CMS content
- Product pages and product metadata (handle-based)

How to keep the frontend swappable:
- Cache based on `/api/*` responses, not on UI routes.
- UI becomes a consumer; caching lives in the edge/API layer.

Acceptance checks:
- A documented cache policy exists per `/api/*` endpoint (TTL, stale-while-revalidate, purge mechanism).
- Cache headers are set by the backend boundary (not by the UI).

---

## 2) Backend boundary scalability (BFF/API)

The backend boundary contract is defined in:
- `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/backend-boundary-contract-v1.md`

Historical context:
- Earlier draft (superseded): `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/backend-boundary-contract-v0.md`

### 2.1 Concurrency and backpressure

First principle:
- Provider rate limits and DB contention are the “real” bottlenecks; backend must absorb load with caching + backpressure.

Plan:
- Add request-level concurrency limits per provider (Shopify, Supabase, Stripe).
- Prefer early returns from cache for GETs.
- For write endpoints (cart/payment), apply idempotency keys and retries only where safe.

Acceptance checks:
- Rate limit failures map to stable errors, not random exceptions.
  - Evidence for a standardized error model in code:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-domains-platform-ports-errors.ts.head.txt`
  - Evidence for rate-limit classification mapping:  
    `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-domains-platform-http-internal-api-client.ts.head.txt`

### 2.2 Error semantics and resiliency

Current state evidence:
