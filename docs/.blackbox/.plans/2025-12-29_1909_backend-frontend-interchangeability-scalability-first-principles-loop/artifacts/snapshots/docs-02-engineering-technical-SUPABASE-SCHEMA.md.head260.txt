# source: 02-engineering/technical/SUPABASE-SCHEMA.md
# captured: 2025-12-30T10:46:12Z

# Supabase Schema Blueprint

Last updated: 2025-11-20. Use this as the source of truth when creating new Supabase migrations or checking whether a table already exists. If you just need to apply the schema, run `docs/supabase-full-schema.sql` in the Supabase SQL editorâ€”it's generated directly from this blueprint.

> General rules
> - UUID primary keys on every table (`gen_random_uuid()`).
> - `created_at` / `updated_at` columns wherever data mutates.
> - Enable RLS on every table; default policy = service role only until Clerk auth is wired up.
> - Use JSONB sparingly (for metadata blobs) and add indexes where noted.

## Creators & Cohorts

### `creators`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | uuid pk | `default gen_random_uuid()` |
| `full_name` | text | required |
| `phone` | text | unique, for dedupe |
| `email` | text | optional contact |
| `tiktok_handle` | text | unique |
| `instagram_handle` | text | optional |
| `audience_size_band` | text | check: `<10k`, `10k-50k`, `50k-250k`, `250k+` |
| `status` | text | default `invited`, check: `invited/active/paused/archived` |
| `cohort_id` | uuid | FK `cohorts.id` |
| `joined_whatsapp_at` | timestamptz | nullable |
| `invite_source` | text | e.g. referral, event |
| `notes` | text | internal notes |
| `created_at` | timestamptz | default `now()` |
| `updated_at` | timestamptz | default `now()` |

**Indexes & policies**
- Unique on `phone`, `tiktok_handle`.
- Btree on `cohort_id`.
- Future policy: creators see their own row when auth wired.

### `cohorts`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |  |
| `slug` text | unique identifier |
| `name` text | display label |
| `brief_url` text | latest doc |
| `whatsapp_group_url` text | default group |
| `capacity` int | default 250 |
| `status` text | default `active` |
| `start_at` / `end_at` | timestamptz | scheduling |
| `created_at` | timestamptz | default `now()` |

**Indexes**: unique `slug`, btree on `status`.

### `creator_applications`
Stores intake data before promotion to `creators`.

| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |  |
| `full_name`, `phone`, `tiktok_handle`, `instagram_handle` | text | snapshot values |
| `audience_size_band`, `heard_from` | text | optional |
| `notes` | text | reviewer notes |
| `status` | text | default `submitted`, check `submitted/reviewing/accepted/rejected` |
| `submitted_at` | timestamptz | default `now()` |
| `processed_by` | text | staff member |
| `processed_at` | timestamptz | nullable |

**Index**: unique on (`phone`,`tiktok_handle`).

### `creator_cohort_activity`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |  |
| `creator_id` | uuid fk `creators` |
| `cohort_id` | uuid fk `cohorts` |
| `event_type` | text | `joined/left/resource_view/note` |
| `metadata` | jsonb | arbitrary payload |
| `created_at` | timestamptz | default `now()` |

**Indexes**: btree on (`creator_id`,`cohort_id`), optional GIN on `metadata`.

### `customers` (Clerk profiles)
Lightweight mirror of the signed-in Clerk user so RLS policies can join on `id`.

| Column | Type | Notes |
| --- | --- | --- |
| `id` text pk | Clerk user ID |
| `email`, `first_name`, `last_name`, `full_name`, `username`, `phone`, `avatar_url` | text | nullable |
| `last_sign_in_at`, `updated_at` | timestamptz | set from the app |

**RLS**: policy `id = auth.jwt()->>'sub'` for all operations, so each user can upsert/select their own row.

## Products & Orders

### `products`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |  |
| `sku` text | unique |
| `title` text | required |
| `description` text | optional |
| `price` numeric(12,2) | >= 0 |
| `image_url` text | optional |
| `tags` text[] | default `{}` |
| `is_active` boolean | default true |
| `created_at`, `updated_at` | timestamptz | defaults `now()` |

**Indexes**: unique `sku`, btree on `is_active`.

### `orders`
Extends the existing `docs/supabase-orders.sql` definition.

| Column | Type | Notes |
| --- | --- | --- |
| `id` text pk | e.g. `LUM-XYZ` |
| `placedAt` timestamptz | ordering BRIN index |
| `creator_id` uuid | FK `creators` (nullable) |
| `status` text | `processing/shipped/delivered/cancelled` |
| `source` text | `checkout_demo/shopify/manual` |
| `subtotal`, `shipping`, `total` | numeric(12,2) |  |
| `events` jsonb | timeline |
| `tracking` text | optional |
| `fulfillment_status` text | granular status |
| `ship_date` timestamptz | nullable |
| `cancel_reason` text | nullable |
| `commission_rate` numeric(5,2) | stored for audit |
| `inserted_at` timestamptz | default `now()` |

**Indexes**: BRIN on `placedAt`, btree on `creator_id`, `fulfillment_status`, `source`.

### `order_items`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |  |
| `order_id` text | FK `orders` |
| `product_id` uuid | FK `products` |
| `sku`, `title` | text | snapshot |
| `unit_price` numeric(12,2) |  |
| `qty` int |  |
| `subtotal` numeric(12,2) | generated `unit_price * qty` |

**Indexes**: `order_id`, `product_id`.

## Earnings & Compliance

### `commissions`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `order_id` text fk |
| `order_item_id` uuid fk |
| `creator_id` uuid fk |
| `amount` numeric(12,2) |
| `rate` numeric(5,2) |
| `status` text | default `pending`, check `pending/approved/paid/hold` |
| `payout_batch_id` uuid fk |
| `notes` text |
| `created_at`, `updated_at` timestamptz |

**Indexes**: `creator_id`, `status`, `payout_batch_id`.

### `payout_batches`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `period_start`, `period_end` date |
| `issued_at` timestamptz |
| `method` text | default `bank_transfer` |
| `reference` text |
| `total_amount` numeric(12,2) |
| `notes` text |
| `created_at` timestamptz |

**Indexes**: btree on `issued_at`; optional unique (`period_start`,`period_end`).

### `compliance_documents`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `creator_id` uuid fk |
| `type` text | `w9/invoice/id_verification` |
| `file_url` text |
| `verified_at` timestamptz |
| `uploaded_by` text |
| `created_at` timestamptz |

**Index**: unique (`creator_id`,`type`).

## Content & Engagement

### `content_assets`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `cohort_id` uuid fk |
| `title` text |
| `type` text | `brief/script/footage/template` |
| `url` text |
| `version` int | default 1 |
| `is_published` boolean | default false |
| `updated_by` text |
| `created_at`, `updated_at` timestamptz |

**Index**: (`cohort_id`,`type`,`is_published`).

### `leaderboard_snapshots`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `captured_at` timestamptz |
| `metric` text |
| `creator_id` uuid fk |
| `rank` int |
| `value` numeric |
| `notes` text |

**Indexes**: (`metric`,`captured_at`), `creator_id`.

### `tracking_events`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `creator_id` uuid fk nullable |
| `event_name` text |
| `page` text |
| `session_id` text |
| `metadata` jsonb |
| `created_at` timestamptz |

**Indexes**: BRIN on `created_at`, GIN on `metadata`, (`event_name`,`created_at`).

### `whatsapp_groups`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `cohort_id` uuid fk |
| `label` text |
| `invite_url` text |
| `capacity` int default 250 |
| `current_members` int default 0 |
| `status` text default `active` |
| `notes` text |
| `created_at` timestamptz |

**Index**: (`cohort_id`,`status`).

## Operations & Automation

### `feature_flags`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `key` text unique |
| `value` jsonb |
| `updated_at` timestamptz |

### `audit_logs`
| Column | Type | Notes |
| --- | --- | --- |
| `id` uuid pk |
| `actor` text |
| `action` text |
| `target_table` text |
