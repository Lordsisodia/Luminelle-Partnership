# Prompt 5 — Tenancy Context Rules (first principles, evidence-anchored)

Goal:
- Define a deterministic “tenant context” resolution and propagation model so:
  - the backend can host many clients/brands
  - the frontend can be swapped without re-implementing tenancy logic

Scope constraints:
- Docs-only output for this loop (no `src/` changes).
- “Current state” observations must anchor to snapshots under:
  - `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/`

Evidence anchors for current primitives we will build on:
- Auth provider is present in frontend boot:  
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-main.tsx.head.txt`
- Supabase access exists as a platform module (so tenancy isolation will touch this boundary):  
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-domains-platform-storage-supabase.ts.head.txt`
- Platform “ports” boundary exists (tenancy must flow behind this):  
  `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/platform-ports-files.txt`

---

## 0) Tenancy as a first-principles boundary concern

Tenancy is not a UI concern:
- If tenancy resolution requires UI changes, the frontend is *not* swappable.
- Tenancy resolution must live at the backend boundary layer (Cloudflare Worker / server-side boundary).

This loop already defines a backend boundary contract at `/api/*` aligned to platform ports:  
`docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/backend-boundary-contract-v1.md`

Historical earlier draft (superseded):
- `docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/backend-boundary-contract-v0.md`

---

## 1) Tenant context object (the “one thing” every layer can rely on)

Define a single tenant context object that is present for every `/api/*` request:
- `tenantId: string` (required)
- `tenantMode: "resolved" | "fallback"` (required; “fallback” is for local/dev or misconfigured domains)
- `tenantDomain: string` (the effective domain used to resolve tenant)
- `actor: { userId?: string; sessionId?: string; roles?: string[] }`
- `request: { requestId: string; ip?: string; userAgent?: string }`

Evidence anchor for “actor is a cross-cutting concern today” (auth provider exists in UI boot):  
`docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-main.tsx.head.txt`

---

## 2) Resolution rules (deterministic, ordered, safe defaults)

### 2.1 Inputs allowed for tenant resolution (server-side only)

Allowed inputs (in order of precedence):
- **A) Host-based resolution** (primary)
  - Use the request `Host` header (and normalized `X-Forwarded-Host` if present) to map domain → tenant.
  - Why: the backend boundary is same-origin (`/api/*`), so Host is the natural multi-tenant key.
- **B) Auth-based resolution** (secondary, optional)
  - Use the authenticated identity to confirm or restrict tenant access (e.g., “user is in tenant X”).
  - Why: protects admin actions and prevents cross-tenant data access.
- **C) Explicit tenant hint** (last resort, constrained)
  - Only allow an explicit tenant hint header for trusted internal calls (edge → internal modules), never from browsers directly.

Evidence anchor that coupling is visible in the repo and thus must be centralized/controlled (vendor coupling scans exist):  
`docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/coupling-supabase-matches.txt`

### 2.2 Host-based resolution: canonical algorithm

Algorithm:
- Extract `effectiveHost`:
  - Prefer `X-Forwarded-Host` if your Cloudflare deployment uses it consistently; else `Host`.
- Normalize:
  - lower-case
  - strip port
  - strip trailing dot
- Resolve tenant:
  - `tenant = tenant_domains[effectiveHost]`
  - If not found:
    - try wildcard mapping policy (`*.clientroot.com`) if you support it
    - else fall back to default tenant for dev/local

Acceptance checks:
- The boundary has a single function responsible for tenant resolution (no copy/paste across handlers).
- A request without a resolvable host never silently becomes “tenant A”; it becomes a known “fallback tenant” with explicit `tenantMode: "fallback"`.

### 2.3 Auth-based resolution: safe intersection, not override

Rule:
- Auth can **restrict** tenant access (intersection), but should not silently override Host resolution.

Acceptance checks:
- If Host resolves tenant X but the authenticated actor does not have access to tenant X, return a stable error code (see PortError system).
- Do not “helpfully” switch tenants based on the user; this breaks determinism and cache correctness.

Evidence anchor for stable error system existing at the platform boundary (PortError codes):  
`docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/src-domains-platform-ports-errors.ts.head.txt`

---

## 3) Propagation rules (how tenant context reaches data + providers)

### 3.1 Backend boundary → platform ports

Rule:
- Every `/api/*` handler must call platform “ports” with a tenant context, either:
  - explicitly as an argument, or
  - via a request-scoped context store that ports read from.

Evidence anchor that platform ports exist as a dedicated boundary layer:  
`docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/platform-ports-files.txt`

### 3.2 Platform ports → adapters (Shopify/Stripe)

Rules:
- Adapters never infer tenant from UI parameters.
- Adapters receive tenant context only from the boundary/runtime (server-side).

Motivation evidence anchor (why we care about keeping vendor coupling below adapters):  
`docs/.blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop/artifacts/snapshots/check-vendor-leaks.txt`
