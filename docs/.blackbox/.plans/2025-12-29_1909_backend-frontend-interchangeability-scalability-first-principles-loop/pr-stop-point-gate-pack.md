# PR Stop-Point Gate Pack (commands + expected evidence deltas)

Goal:
- Make implementation progress measurable and safe by defining:
  - exact commands to run after each PR
  - exactly which evidence snapshot files should change (and how)

This is the “operator manual” for `pr-by-pr-stop-points-plan.md`.

Evidence anchors:
- Acceptance gates runbook (baseline gates): `acceptance-gates-runbook.md`
- Endpoint table (current surface + cues): `backend-boundary-contract-v1.1-endpoint-table.md`
- Gap report: `contract-gaps-report-v1.1.md`

---

## Setup (always)

From `docs/`:
- `PLAN=".blackbox/.plans/2025-12-29_1909_backend-frontend-interchangeability-scalability-first-principles-loop"`
- `SNP="$PLAN/artifacts/snapshots"`
- `ls -la "$SNP" > "$SNP/_snapshot-index.ls.txt"`

---

## Core gate commands (reusable)

These are safe to run any time:

- One-command full gate refresh (recommended)
  - `./.blackbox/scripts/refresh-1909-all-gates.sh`
  - Evidence snapshot of the script (for audit):  
    `artifacts/snapshots/docs-blackbox-scripts-refresh-1909-all-gates.sh.head220.txt`

- One-command refresh (recommended)
  - `./.blackbox/scripts/refresh-1909-contract-evidence.sh`
  - Evidence snapshot of the script (for audit):  
    `artifacts/snapshots/docs-blackbox-scripts-refresh-1909-contract-evidence.sh.head200.txt`

- `/api/*` inventory
  - `find ../functions/api -type f | sed 's|^../||' | sort > "$SNP/functions-api-files.clean.find.txt"`
  - `rg -n "^export const onRequest" ../functions/api > "$SNP/functions-api-handlers.clean.rg.txt" || true`

- Adapter import boundaries (UI/client must remain clean)
  - `rg -n "@platform/.*/adapters" ../src > "$SNP/boundary-adapter-imports.rg.txt" || true`
  - `rg -n "domains/platform/.*/adapters" ../src/ui ../src/domains/client > "$SNP/boundary-adapter-imports.ui-client.rg.txt" || true`

- Vendor leak scan (baseline → hard gate later)
  - `./.blackbox/scripts/check-vendor-leaks.sh > "$SNP/check-vendor-leaks.txt" || true`

- Vendor SDK import drift (report-only; keep UI coupling intentional)
  - Produced by `refresh-1909-all-gates.sh` and stored as:
    - `artifacts/snapshots/boundary-vendor-sdk-imports.nonplatform.rg.txt`

- Backend surface drift (legacy `api/**` vs canonical `functions/api/**`)
  - Produced by `refresh-1909-all-gates.sh` and stored as:
    - `artifacts/snapshots/api-vs-functions.summary.txt`
    - `artifacts/snapshots/api-only-endpoints.txt`
    - `artifacts/snapshots/functions-only-endpoints.txt`

- Checkout proxy/handoff seam (keeps vendor checkout routes/domains out of UI)
  - Produced by `refresh-1909-all-gates.sh` and stored as:
    - `artifacts/snapshots/functions-cart-c-catchall.ts.head200.txt`
    - `artifacts/snapshots/functions-checkouts-catchall.ts.head200.txt`
    - `artifacts/snapshots/functions-_lib-shopifyCheckoutProxy.ts.head240.txt`

- Function implementation cue scans (auth/tenant/cache/security)
  - `rg -n "Authorization|Bearer |getToken\\(|clerk|Clerk|requireInternalAuth\\(|X-Forwarded-Host|\\bHost\\b|tenant" ../functions/api > "$SNP/functions-api-auth-tenant-cues.rg.txt" || true`
  - `rg -n "Cache-Control|Vary\\b|ETag\\b|s-maxage|max-age|no-store|cache|jsonTenantPublic\\(|jsonNoStore\\(" ../functions/api > "$SNP/functions-api-cache-cues.rg.txt" || true`
  - `rg -n "X-Shopify|hmac|webhook|signature|SHOPIFY" ../functions/api > "$SNP/functions-api-shopify-security-cues.rg.txt" || true`

---

## P0.3 — Consolidate backend boundary surface (api/** → functions/api/**)

Reference (implementation recipes):
- `p0-3-boundary-consolidation-detailed-plan.md`

Run:
- Core gate commands above (especially the one-command full gate refresh):
  - `./.blackbox/scripts/refresh-1909-all-gates.sh`

Immediate “thin-slice” target (after migrating the two MIGRATE_NOW endpoints):
- Add canonical handlers for:
  - `/api/newsletter/subscribe` → `functions/api/newsletter/subscribe.ts`
  - `/api/cloudinary/sign` → `functions/api/cloudinary/sign.ts`  
  Reference: `p0-3-boundary-consolidation-detailed-plan.md`
- Expected drift summary deltas (relative to the current baseline in `artifacts/snapshots/api-vs-functions.summary.txt`):
  - `api_only`: decreases by **2** (these two endpoints move from `api_only` → `common`)
  - `functions_endpoints`: increases by **2** (new canonical handlers added)
  - `common`: increases by **2**
  - `functions_only`: unchanged (unless you add brand-new endpoints that don’t exist in `api/**`)

Expected evidence deltas:
- Drift summary changes as parity is established:
  - `api-vs-functions.summary.txt` (`api_only` should decrease over time)
  - `api-only-endpoints.txt` (shrinks as endpoints are mirrored into `functions/api/**`)
  - `functions-api-files.clean.find.txt` may grow if new canonical handlers are added
- P0.3 triage snapshots stay up to date (now auto-generated by `refresh-1909-all-gates.sh`):
  - `api-only-endpoints.exact-usage.latest.txt` (so you can see what’s called by UI/scripts)
  - `api-only-endpoints.handlers.head80.txt` (so you can inspect legacy implementations quickly)
- No regressions in swappability gates:
  - `boundary-adapter-imports.ui-client.rg.txt` remains empty
  - `check-vendor-leaks.txt` unchanged (unless you intentionally touch UI key mapping)

What “good” means:
- The Cloudflare boundary (`functions/api/**`) contains every endpoint required by the current UI (and the legacy `api/**` surface is effectively frozen).

---

## PR 1 — Add shared boundary primitives (tenant + auth + cache) with no wiring

Run:
- Core gate commands above.

Expected evidence deltas:
- `functions-api-files.clean.find.txt` and `functions-api-handlers.clean.rg.txt`: unchanged (no new endpoints).
- Cue scans: unchanged or minimal.
- New `_lib` heads (if captured) should show added files; update snapshot index.

What “good” means:
- Helpers exist but endpoints still behave the same.

---

## PR 2 — Wire auth guards into admin/exports/metrics/orders endpoints

Run:
- Core gate commands above (especially auth/tenant cue scan).

Expected evidence deltas:
- `functions-api-auth-tenant-cues.rg.txt`: should gain matches within:
  - `functions/api/admin/**`
  - `functions/api/exports/**`
  - `functions/api/metrics/**`
  - `functions/api/orders/**`
- (Optional) regenerate endpoint table + gaps report if you keep them in sync:
  - `backend-boundary-contract-v1.1-endpoint-table.md`
  - `contract-gaps-report-v1.1.md`

What “good” means:
- Admin surface no longer looks unauthenticated by scan.

---

## PR 3 — Wire tenant resolution into tenant-scoped endpoints

Run:
- Core gate commands above.
- Recommended: follow the detailed plan:
  - `pr-3-tenant-resolution-detailed-plan.md`

Expected evidence deltas:
- `functions-api-auth-tenant-cues.rg.txt`: should start showing host/tenant cues (or a common helper usage) across:
  - `functions/api/storefront/**`
  - `functions/api/customer/**`
  - `functions/api/payments/**`
  - `functions/api/experiment/**` (if tenant-scoped)

What “good” means:
- Tenant resolution appears once per handler (or via a shared wrapper) and is no longer accidental.

---

## PR 4 — Normalize cache headers for public endpoints

Run:
- Core gate commands above (especially cache cue scan).
- Recommended: follow the detailed plan:
  - `pr-4-cache-headers-detailed-plan.md`

Expected evidence deltas:
- `functions-api-cache-cues.rg.txt`: should include explicit cache policy in:
  - `functions/api/storefront/landing/sections.ts`
  - `functions/api/storefront/product/*`
  - `functions/api/experiment/config.ts` (already uses ETag; align policy)

What “good” means:
- Public endpoints set explicit cache headers and remain tenant-safe.

---

## PR 5 — Add tenancy tables (Supabase) without changing runtime behavior

Run:
- Core gate commands above (mostly unchanged).
- Recommended: follow the detailed plan:
  - `pr-5-tenancy-tables-detailed-plan.md`
- Record migration evidence separately (outside this plan) once you implement DB changes.

Expected evidence deltas:
- None in `functions/api/**` unless you add endpoints for tenant config.

What “good” means:
- Tables exist; app behavior unchanged for tenant #1.

---

## PR 6 — Switch provider config lookup from env → tenant_integrations (still single tenant)

Run:
- Core gate commands above.
- Recommended: follow the detailed plan:
  - `pr-6-tenant-integration-config-lookup-detailed-plan.md`
- Add a new “env usage scan” snapshot (optional) to track remaining provider env coupling.

Expected evidence deltas:
- Depends on implementation; this PR should reduce reliance on env variables for tenant-specific provider config.

---

## PR 7 — Eliminate vendor ID leaks above adapters (key mapping)

Run:
- Core gate commands above (especially vendor leak scan).
- Recommended: follow the detailed plan:
  - `pr-7-vendor-key-mapping-detailed-plan.md`

Expected evidence deltas:
- `check-vendor-leaks.txt`: `disallowed_lines` decreases toward 0.
  - Current baseline is 5 disallowed lines (two unique Variant GIDs repeated).  
    Evidence: `artifacts/snapshots/check-vendor-leaks.txt`
  - Supporting “exact offender line” snapshots (useful when reviewing the PR):
    - `artifacts/snapshots/vendor-leaks-src-ui-providers-DrawerProvider.tsx.L130-190.txt`
    - `artifacts/snapshots/vendor-leaks-src-domains-client-shop-cart-logic-volumeDiscounts.ts.L1-120.txt`
    - `artifacts/snapshots/vendor-leaks-src-domains-client-shop-products-data-product-config.ts.L160-260.txt`

What “good” means:
- Vendor leak scan reaches 0 for UI/client/lib and becomes a hard gate.

---

## PR 8 — Onboard tenant #2 (proof)

Run:
- Core gate commands above.
- Recommended: follow the detailed plan:
  - `pr-8-tenant-2-onboarding-detailed-plan.md`
- Run the tenant onboarding runbook checks.

Expected evidence deltas:
- Mostly operational docs + runbook outputs; code changes depend on how you implement tenant config.

What “good” means:
- Tenant #2 can be served from the same backend with deterministic tenant resolution and no cross-tenant cache leaks.

---

## PR 9 — Identity decoupling (reduce Clerk coupling outside platform/auth)

Run:
- Core gate commands above (especially the vendor SDK drift scan).
- Recommended: follow the detailed plan:
  - `pr-9-identity-decoupling-detailed-plan.md`

Expected evidence deltas:
- Vendor SDK drift report shrinks (goal: Clerk imports outside platform/auth trend to 0):
  - `boundary-vendor-sdk-imports.nonplatform.rg.txt`
  - `stop-point-metrics.latest.txt`

What “good” means:
- Identity provider coupling is localized and measurable (no surprise Clerk dependencies in client/UI domains).

---

## PR 10 — Storefront DTO normalization (provider-neutral storefront boundary)

Run:
- Core gate commands above.
- Recommended: follow the detailed plan:
  - `pr-10-storefront-dto-normalization-detailed-plan.md`
- During this PR, run the runtime DTO neutrality checks described in:
  - `acceptance-gates-runbook.md` (Gate F)

Expected evidence deltas:
- New runtime response evidence snapshots captured under `artifacts/snapshots/`:
  - `storefront-v2-product.response.<timestamp>.json` (example filename; see runbook)
  - `storefront-v2-product.gid-leaks.<timestamp>.txt` (should be empty)
- (Optional) New v2 endpoint inventories appear in:
  - `functions-api-files.clean.find.txt`

What “good” means:
- Storefront endpoints return provider-neutral DTOs and a frontend can integrate without Shopify IDs or Shopify object shapes.
