# Progress Log

- 2025-12-29 19:21 — Prompt 1 complete (invariants + acceptance checks + inspection plan) — establishes a measurable definition of “frontend swappable + scalable”.
- 2025-12-29 19:29 — Prompt 2 complete (evidence snapshots captured) — future claims can cite saved command outputs under `artifacts/snapshots/`.
- 2025-12-29 19:36 — Prompt 3 complete (boot/composition + backend contract v0 drafted) — converts repo evidence into a concrete boundary proposal.
- 2025-12-29 19:42 — Prompt 4 complete (scalability plan drafted) — defines edge/UI, backend, and Supabase scaling with measurable guardrails.
- 2025-12-29 19:55 — Prompt 5 complete (tenancy context rules drafted) — adds deterministic, cache-safe tenant resolution + propagation and links it into the contract v0.
- 2025-12-30 — Generated contract v1.1 endpoint table + heuristic gaps report from the live `/api/*` surface; added gate-refresh scripts and an auto dashboard.
- 2025-12-30 — Expanded backend/frontend boundary docs with DTO/capabilities spec and an evidence-first architecture atlas.
- 2025-12-30 — Added research-driven platform expansion docs (authz/audit/flags/automation/cms/analytics) and corresponding ADRs to prevent drift.
- 2025-12-30 — Consolidated plan navigation (canonical docs map, artifact map) and marked placeholder templates as deprecated to reduce confusion.
- 2025-12-30 — Defined tenant secrets storage strategy + `/api/config/public` allowlist so multitenancy can scale without per-tenant env vars.
- 2025-12-30 — Fixed contract auth cue scan to detect `requireInternalAuth(`, reducing false positives in `contract-gaps-report-v1.1.md` and improving the stop-point dashboard signal.
- 2025-12-30 — Added an implementation-ready PR 2 auth wiring plan (`pr-2-auth-guards-detailed-plan.md`) and updated plan entrypoints/indices to reference it.
- 2025-12-30 — Added an implementation-ready PR 3 tenant-resolution wiring plan (`pr-3-tenant-resolution-detailed-plan.md`) and linked it from the PR roadmap + entrypoints.
- 2025-12-30 — Refined cache gap heuristics to require explicit cache policy (Cache-Control / ttl helpers), and added an implementation-ready PR 4 caching plan (`pr-4-cache-headers-detailed-plan.md`).
- 2025-12-30 — Added implementation-ready PR 5/6 plans for multitenancy enablement (Supabase tenancy tables + tenant integration config lookup) and captured a functions→Supabase usage inventory for grounding.
- 2025-12-30 — Added an implementation-ready PR 7 plan to eliminate Shopify GIDs from UI/client code via internal key mapping (drives vendor leak scan to 0).
- 2025-12-30 — Added an implementation-ready PR 8 tenant #2 onboarding plan that ties the runbook to the earlier stop-point outputs (tenant tables, config lookup, cache safety, auth).
- 2025-12-30 — Added stable “legacy/aux inventories” snapshots (repo top-level + `api/` + `server/`) and clarified that `functions/api/**` is the canonical swappable boundary in this plan.
- 2025-12-30 — Added a quantified “api/** vs functions/api/**” drift signal to the gate suite + stop-point dashboard, and triaged api-only endpoints by repo usage so boundary consolidation is scoped and measurable.
- 2025-12-30 — Captured snapshots of key legacy `api/**` endpoint implementations (newsletter, cloudinary, media) to de-risk the P0.3 migration into `functions/api/**`.
- 2025-12-30 — Filled the rolling context “always read” memory (`context/context.md`), added a detailed P0.3 consolidation plan, and made gate refresh scripts automatically write timestamped logs into `artifacts/snapshots/`.
- 2025-12-30 — Made the gate suite self-auditing by snapshotting the producing scripts (heads) and scripts dir listing on every `refresh-1909-all-gates.sh` run; updated runbook + gate pack to point to P0.3.
- 2025-12-30 — Expanded `external-research-notes.md` to include plugin architecture, internal API-first, key mapping, and Supabase multitenancy takeaways (all evidence-backed by in-plan snapshots).
- 2025-12-30 — Updated the stop-point dashboard to track P0.3 explicitly and updated the PR diff template to include the drift evidence files used to validate P0.3.
- 2025-12-30 — Added a P0.3 evidence diff template (ignored by the dashboard) and improved dashboard linking to prefer real completion diffs over templates.
- 2025-12-30 — Fixed the backend surface drift metric to exclude legacy `api/**` helper modules (pkce/utils/_verify) and captured a full “api-only handlers heads” snapshot for evidence-backed triage.
- 2025-12-30 — Added a parity table to the P0.3 plan covering all remaining `api_only` endpoints and regenerated the `api-only-endpoints.exact-usage.latest.txt` snapshot so triage matches the corrected drift list.
- 2025-12-30 — Updated `refresh-1909-all-gates.sh` to automatically generate P0.3 triage snapshots (`api-only-endpoints.exact-usage.latest.txt` + `api-only-endpoints.handlers.head80.txt`) alongside the drift diff.
- 2025-12-30 — Updated the acceptance gates runbook + gate pack to reference the auto-generated P0.3 triage snapshots, keeping “one command → all evidence” discoverable.
- 2025-12-31 — Resolved remaining P0.3 “INVESTIGATE” endpoints (checkouts webhooks, shopify billing/settings/sync, og) using repo evidence (Shopify auth callback + webhook registration script + usage scans), updated the parity table to `DEFER`, and added a one-glance swap matrix to the component catalog.
- 2025-12-31 — Expanded P0.3 “MIGRATE_NOW” recipes with explicit legacy request/response contracts, added a P0.3 execution checklist, captured Cloudinary/newsletter supporting evidence snapshots, and documented expected drift deltas for the initial thin slice (api_only should drop by 2 after migrating newsletter+cloudinary).
- 2025-12-31 — Added a concrete Supabase SQL migration draft for `public.newsletter_signups` (RLS service-role insert/read) to remove the last “runtime DDL” dependency before migrating `/api/newsletter/subscribe` to Cloudflare.
- 2025-12-31 — Added Cloudflare-compatible SHA1 signing guidance (Web Crypto snippet) for migrating `/api/cloudinary/sign` off Node `crypto` while preserving legacy signature semantics.
- 2025-12-31 — Snapshotted the exact vendor leak lines and updated PR 7 plan with a concrete GID → VariantKey mapping proposal so vendor key mapping can be executed deterministically.
- 2025-12-31 — Reconciled key mapping specs with current Shopify adapter behavior (v0 reversible encoded GID keys) and updated PR7 to require a stable-key mapping registry + resolver inside the adapter boundary for true provider swaps.
- 2025-12-31 — Hardened the vendor leak gate to also detect base64url-encoded Shopify GIDs embedded in `variant.<token>` strings in UI/client/lib (prevents “obfuscated vendor IDs” from passing the scan).
- 2025-12-31 — Refreshed the full gate bundle, synced `artifacts/invariants-and-acceptance.md` with the canonical invariants, added a backend “inspect first” list, captured checkout proxy/catchall/webhook snapshots, and expanded the architecture atlas with evidence-backed end-to-end flow maps.
- 2025-12-31 — Added a research index with pinned upstream excerpts, added a first-class checkout proxy acceptance gate, and hardened `refresh-1909-all-gates.sh` to auto-snapshot the checkout proxy seam.
- 2025-12-31 — Added a checkout proxy seam health signal to the stop-point dashboard so this core swappability seam is continuously visible (not just implied).
- 2025-12-31 — Updated the PR stop-point gate pack + PR evidence diff template to explicitly track checkout proxy seam evidence alongside drift/vendor-leak metrics.
- 2025-12-31 — Added layer-specific architecture convention maps (domains, boundary, data) and expanded the client-project modularity blueprint with a pragmatic `apps/*` + `packages/*` target; updated plan navigation to include these maps.
- 2025-12-31 — Archived excess OSS discovery plan runs into `.blackbox/.plans/_archive` (keeping only newest N + ledger-referenced) and added a reusable `archive-oss-plans.py` script to make this maintenance step repeatable.
- 2025-12-31 — Linked the OSS accelerators map into plan indices, refreshed gates + snapshot index, and removed remaining `<fill>` placeholders from compactions so the loop can resume cleanly.
- 2025-12-31 — Added a provider swap playbook (Shopify/Stripe/etc.) and a platform domain readiness matrix so “what swaps today” is explicit; refreshed gates + dashboard for current evidence.
- 2025-12-31 — Refreshed the full 1909 gate bundle + regenerated the stop-point dashboard via `./.blackbox/scripts/run-1909-loop.sh`, then captured additional repo topology snapshots (src + domains + platform runtime) to ground further architecture mapping; filled the latest checkpoint step file so the loop has no remaining `<fill>` placeholders. Evidence: `artifacts/snapshots/run-1909-loop.2025-12-31_122926.log.txt`, `artifacts/snapshots/repo-structure.src-overview.2025-12-31_122954.txt`, `artifacts/snapshots/src-domains.platform.files.2025-12-31_123126.txt`
- 2025-12-31 — Extended `refresh-1909-all-gates.sh` to refresh `src/**` topology + key boundary file extracts and to snapshot provider env reads in `functions/**`; added a plan-wide snapshot citation audit so evidence references can’t silently rot. Evidence: `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_064038.log.txt`, `artifacts/snapshots/plan-snapshot-reference-audit.latest.txt`
- 2025-12-31 — Updated the gate suite to refresh vendor coupling scans (Clerk/Shopify/Stripe/Supabase) on every run so “what’s still coupled?” stays evidence-backed. Evidence: `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_075609.log.txt`, `artifacts/snapshots/coupling-supabase-matches.txt`
- 2025-12-31 — Documented a vendor SDK import isolation gate (report-only) and updated swap/scalability docs to treat identity UI + capability-gated embedded flows as explicit exceptions; refreshed the full evidence bundle + dashboard so the baseline is current. Evidence: `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_112121.log.txt`, `artifacts/snapshots/boundary-vendor-sdk-imports.nonplatform.rg.txt`, `artifacts/snapshots/stop-point-metrics.latest.txt`
- 2025-12-31 — Added vendor SDK import drift counts into the stop-point dashboard + metrics so the exception posture stays continuously visible (total + clerk + stripe), and updated the dashboard “OK/WARN” wording to support threshold-based signals. Evidence: `artifacts/snapshots/stop-point-metrics.latest.txt`, `stop-point-status-dashboard.md`
- 2025-12-31 — Updated the PR gate pack + PR evidence diff template to include the vendor SDK drift snapshot so future implementation PRs can’t accidentally add coupling without documenting it. Evidence: `artifacts/snapshots/boundary-vendor-sdk-imports.nonplatform.rg.txt`, `pr-stop-point-gate-pack.md`
- 2025-12-31 — Captured targeted auth context evidence (AuthProvider shim + ClerkShell) and documented an identity swap readiness target (drive Clerk imports outside platform/auth to 0 via the vendor SDK drift signal). Evidence: `artifacts/snapshots/src-domains-platform-auth-providers-AuthContext.impl.tsx.head240.txt`, `artifacts/snapshots/src-shells-ClerkShell.tsx.head200.txt`
- 2025-12-31 — Expanded `inspect-first.md` to include the auth seam, added an explicit identity section to the architecture atlas, and ingested the earlier 1844 architecture/coupling run as local research excerpts to improve cross-checking while keeping evidence local. Evidence: `inspect-first.md`, `architecture-atlas.md`, `artifacts/snapshots/research-plan-1844-architecture-map-improvements.final-report.head220.txt`
- 2025-12-31 — Made plan evidence anchors self-refreshing by regenerating `plan-*.head*.txt` snapshots on every gate run, then added a minimal blackbox hygiene audit + pinned-plan index for operator UX. Evidence: `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_121847.log.txt`, `artifacts/snapshots/plan-migration-stages.md.head120.txt`, `blackbox-hygiene-audit.md`
- 2025-12-31 — Extended `refresh-1909-all-gates.sh` to snapshot a `check-blackbox` run into the plan evidence bundle on every run (keeps runtime/template integrity continuously visible during long runs). Evidence: `artifacts/snapshots/check-blackbox.latest.txt`, `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_122432.log.txt`
- 2025-12-31 — Reduced “two copies of the same doc” drift risk by converting duplicate artifact docs into explicit canonical pointers (inspect-first, inspect-first-backend, RUN-NOW) and making the root invariants file a pointer to the canonical invariants under `artifacts/`. Evidence: `context/steps/0065_checkpoint-canonical-pointers-for-duplicate-artifact-docs.md`
- 2025-12-31 — Extended the gate refresh evidence bundle to include `.blackbox` root + `.plans` directory listings (timestamped + stable latest) so docs-only cleanup work is auditable via diffs. Evidence: `artifacts/snapshots/docs-blackbox-root.ls.latest.txt`, `artifacts/snapshots/docs-blackbox-plans.ls.latest.txt`
- 2025-12-31 — Ingested the storefront primitives kit + Blocks Kit research into the 1909 plan (local snapshots + research index update), expanded the DTO/capabilities spec with a proposed storefront DTO thin slice, and added a first-class “UI kit” component section; refreshed the full gate bundle + dashboard and filled checkpoint step 0067. Evidence: `artifacts/snapshots/research-plan-0647-storefront-kit.step0001.head220.txt`, `artifacts/snapshots/oss-catalog-blocks-inventory.storefront-v1.5.150-270.txt`, `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_145229.log.txt`, `context/steps/0067_checkpoint-ingest-storefront-kit-research-into-dto-kit-architecture.md`
- 2025-12-31 — Captured missing storefront cart endpoint snapshots, wrote an evidence-backed mapping from `/api/storefront/*` endpoints to provider-neutral storefront DTOs, and updated plan navigation; refreshed the full gate bundle + dashboard and filled checkpoint step 0068. Evidence: `storefront-contract-dto-mapping-v0.1.md`, `artifacts/snapshots/functions-_lib-storefront.ts.head280.txt`, `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_150036.log.txt`, `context/steps/0068_checkpoint-map-api-storefront-endpoints-to-provider-neutral-dtos.md`
- 2025-12-31 — Added a PR10 detailed plan for storefront DTO normalization (provider-neutral boundary), captured evidence of current `/api/storefront/*` usage within platform adapters, and wired PR10 into the PR roadmap + canonical maps; refreshed gates + dashboard and filled checkpoint step 0069. Evidence: `pr-10-storefront-dto-normalization-detailed-plan.md`, `artifacts/snapshots/rg-src-api-storefront-usage.latest.txt`, `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_150500.log.txt`, `context/steps/0069_checkpoint-add-pr10-storefront-dto-normalization-plan.md`
- 2025-12-31 — Integrated storefront DTO normalization into the canonical backend boundary contract and added a future acceptance gate (G7) to make “storefront DTO neutrality” measurable during PR10; refreshed gates + dashboard and recorded the checkpoint in compaction 0007 (steps 0061–0070). Evidence: `backend-boundary-contract-v1.md`, `acceptance-gates.md`, `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_150716.log.txt`, `context/compactions/compaction-0007.md`
- 2025-12-31 — Added Gate F runtime instructions to the acceptance gates runbook so PR10 can capture concrete response evidence (“no `gid://shopify/` in storefront DTO responses”); refreshed gates + dashboard and filled checkpoint step 0071. Evidence: `acceptance-gates-runbook.md`, `artifacts/snapshots/refresh-1909-all-gates.2025-12-31_151045.log.txt`, `context/steps/0071_checkpoint-add-gate-f-runtime-instructions-for-storefront-dto-neutrality.md`
- 2025-12-31 — Updated the PR stop-point gate pack to include explicit evidence deltas for PR9 (identity decoupling) and PR10 (storefront DTO normalization), including the runtime DTO neutrality evidence filenames from Gate F; filled checkpoint step 0072. Evidence: `pr-stop-point-gate-pack.md`, `context/steps/0072_checkpoint-add-pr9-pr10-evidence-deltas-to-gate-pack.md`
- 2025-12-31 — Ingested the Blog Page Kit mini‑POC checklist as a first-class research input (content UI modularity) and linked it into the research index + architecture expansion docs; refreshed gates and recorded new checkpoints. Evidence: `artifacts/snapshots/research-plan-0551-blog-kit.step0002.head220.txt`, `research-index.md`, `architecture-expansion-from-research.md`, `context/steps/0073_checkpoint-refresh-gates-ingest-blog-kit-research-excerpt.md`
- 2025-12-31 — Added a deterministic 6–10 hour / ~50 prompt agent cycle script and linked it from the plan entrypoints, so long-running loops can proceed without prompt thrash. Evidence: `agent-cycle-prompts-50.md`, `agent-cycle.md`, `START-HERE.md`, `context/steps/0074_checkpoint-add-50-prompt-agent-cycle-script.md`
- 2025-12-31 — Refreshed the 1909 gate bundle + regenerated the stop-point dashboard and confirmed the next PR is still P0.3 (metrics unchanged). Evidence: `stop-point-status-dashboard.md`, `artifacts/snapshots/stop-point-metrics.latest.txt`, `context/steps/0079_checkpoint-refresh-gates-confirm-p0-3-still-next.md`
- 2025-12-31 — Added `NEXT.md` as a single short “what now?” entrypoint (linked from `START-HERE.md` + `CANONICAL.md`) so resuming the plan is one click instead of re-reading `status.md`. Evidence: `NEXT.md`
- 2025-12-31 — Refreshed the full 1909 gate bundle, updated P0.3 docs to match the latest drift list (`api_only=13`, scripts usage `1`), regenerated parity coverage, and made `run-1909-loop.sh` persist its output to `run-1909-loop.latest.txt`. Evidence: `artifacts/snapshots/stop-point-metrics.latest.txt`, `artifacts/snapshots/api-only-endpoints.txt`, `artifacts/snapshots/p0-3_parity-table-coverage.latest.txt`, `artifacts/snapshots/run-1909-loop.latest.txt`
